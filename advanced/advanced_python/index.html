
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Advanced Python Constructs &#8212; Scientific Python Lectures</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/exercise.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'advanced/advanced_python/index';</script>
    <link rel="canonical" href="https://lectures.scientific-python.org/advanced/advanced_python/index.html" />
    <link rel="icon" href="../../_static/sp_lectures.png"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Advanced NumPy" href="../advanced_numpy/index.html" />
    <link rel="prev" title="Advanced topics" href="../index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/sp_lectures.png" class="logo__image only-light" alt="Scientific Python Lectures - Home"/>
    <script>document.write(`<img src="../../_static/sp_lectures.png" class="logo__image only-dark" alt="Scientific Python Lectures - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting started with Python for Science</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../intro/index.html">Getting started with Python for science</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/intro.html">Python scientific computing ecosystem</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../intro/language/python_language.html">The Python language</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/first_steps.html">First steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/basic_types.html">Basic types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/control_flow.html">Control Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/functions.html">Defining functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/reusing_code.html">Reusing code: scripts and modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/io.html">Input and Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/standard_library.html">Standard Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/exceptions.html">Exception handling in Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/oop.html">Object-oriented programming (OOP)</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../intro/numpy/index.html">NumPy: creating and manipulating numerical data</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../intro/numpy/array_object.html">The NumPy array object</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/numpy/operations.html">Numerical operations on arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/numpy/elaborate_arrays.html">More elaborate arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/numpy/advanced_operations.html">Advanced operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/numpy/exercises.html">Some exercises</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/matplotlib/index.html">Matplotlib: plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/scipy/index.html">SciPy : high-level scientific computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/help/help.html">Getting help and finding documentation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Advanced topics</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Advanced topics</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Advanced Python Constructs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_numpy/index.html">Advanced NumPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debugging/index.html">Debugging code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimizing/index.html">Optimizing code</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../scipy_sparse/introduction.html">Introduction</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../scipy_sparse/storage_schemes.html">Storage Schemes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scipy_sparse/solvers.html">Linear System Solvers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scipy_sparse/other_packages.html">Other Interesting Packages</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../image_processing/index.html">Image manipulation and processing using NumPy and SciPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mathematical_optimization/index.html">Mathematical optimization: finding minima of functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../interfacing_with_c/interfacing_with_c.html">Interfacing with C</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Packages and applications</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../packages/index.html">Packages and applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages/statistics/index.html">Statistics in Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages/sympy.html">Sympy : Symbolic Mathematics in Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages/scikit-image/index.html"><code class="docutils literal notranslate"><span class="pre">scikit-image</span></code>: image processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages/scikit-learn/index.html">scikit-learn: machine learning in Python</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About the Scientific Python Lectures</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About the Scientific Python Lecture notes</a></li>




</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-launch-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Launch interactive content">
    <i class="fas fa-rocket"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="interact/lab/index.html?path=advanced/advanced_python/index.ipynb" target="_blank"
   class="btn btn-sm dropdown-item"
   title="Launch via JupyterLite"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  
    <img alt="JupyterLite logo" src="../../_static/images/logo_jupyterlite.svg">
  </span>
<span class="btn__text-container">JupyterLite</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/scipy-lectures/scientific-python-lectures" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/scipy-lectures/scientific-python-lectures/edit/main/advanced/advanced_python/index.Rmd" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/scipy-lectures/scientific-python-lectures/issues/new?title=Issue%20on%20page%20%2Fadvanced/advanced_python/index.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/advanced/advanced_python/index.Rmd" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.Rmd</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Advanced Python Constructs</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#iterators-generator-expressions-and-generators">Iterators, generator expressions and generators</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#iterators">Iterators</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generator-expressions">Generator expressions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generators">Generators</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bidirectional-communication">Bidirectional communication</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#chaining-generators">Chaining generators</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decorators">Decorators</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#replacing-or-tweaking-the-original-object">Replacing or tweaking the original object</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decorators-implemented-as-classes-and-as-functions">Decorators implemented as classes and as functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#copying-the-docstring-and-other-attributes-of-the-original-function">Copying the docstring and other attributes of the original function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deprecation-of-functions">Deprecation of functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-while-loop-removing-decorator">A <code class="docutils literal notranslate"><span class="pre">while</span></code>-loop removing decorator</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-plugin-registration-system">A plugin registration system</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#context-managers">Context managers</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#catching-exceptions">Catching exceptions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-generators-to-define-context-managers">Using generators to define context managers</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="advanced-python-constructs">
<h1>Advanced Python Constructs<a class="headerlink" href="#advanced-python-constructs" title="Link to this heading">#</a></h1>
<p><strong>Author</strong> <em>Zbigniew Jędrzejewski-Szmek</em></p>
<p>This section covers some features of the Python language which can
be considered advanced — in the sense that not every language has
them, and also in the sense that they are more useful in more
complicated programs or libraries, but not in the sense of being
particularly specialized, or particularly complicated.</p>
<p>It is important to underline that this chapter is purely about the
language itself — about features supported through special syntax
complemented by functionality of the Python stdlib, which could not be
implemented through clever external modules.</p>
<p>The process of developing the Python programming language, its syntax,
is very transparent; proposed changes are
evaluated from various angles and discussed via <em>Python Enhancement
Proposals</em> — <a class="reference external" href="https://peps.python.org/">PEPs</a>. As a result, features described in this chapter
were added after it was shown that they indeed solve real problems and
that their use is as simple as possible.</p>
<section id="iterators-generator-expressions-and-generators">
<h2>Iterators, generator expressions and generators<a class="headerlink" href="#iterators-generator-expressions-and-generators" title="Link to this heading">#</a></h2>
<section id="iterators">
<h3>Iterators<a class="headerlink" href="#iterators" title="Link to this heading">#</a></h3>
<aside class="sidebar">
<p class="sidebar-title">Simplicity</p>
<p>Duplication of effort is wasteful, and replacing the various
home-grown approaches with a standard feature usually ends up
making things more readable, and interoperable as well.</p>
<blockquote>
<div><p><em>Guido van Rossum</em> — <a class="reference external" href="https://www.artima.com/weblogs/viewpost.jsp?thread=86641">Adding Optional Static Typing to Python</a></p>
</div></blockquote>
</aside>
<p>An iterator is an object adhering to the <a class="reference external" href="https://docs.python.org/dev/library/stdtypes.html#iterator-types">iterator protocol</a> — basically this
means that it has a <code class="docutils literal notranslate"><span class="pre">next</span> <span class="pre">&lt;iterator.next&gt;</span></code> method, which, when called, returns
the next item in the sequence, and when there’s nothing to return, raises the
<code class="docutils literal notranslate"><span class="pre">StopIteration</span> <span class="pre">&lt;exceptions.StopIteration&gt;</span></code> exception.</p>
<p>An iterator object allows to loop just once. It
holds the state (position) of a single iteration, or from the other
side, each loop over a sequence requires a single iterator
object. This means that we can iterate over the same sequence more
than once concurrently. Separating the iteration logic from the
sequence allows us to have more than one way of iteration.</p>
<p>Calling the <code class="docutils literal notranslate"><span class="pre">__iter__</span> <span class="pre">&lt;object.__iter__&gt;</span></code> method on a container to
create an iterator object is the most straightforward way to get hold
of an iterator. The <code class="docutils literal notranslate"><span class="pre">iter</span></code> function does that for us, saving a few
keystrokes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nums</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span>      <span class="c1"># note that ... varies: these are different objects</span>
<span class="nb">iter</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;list_iterator at 0x10840fc70&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nums</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;list_iterator at 0x10840dba0&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">nums</span><span class="o">.</span><span class="fm">__reversed__</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;list_reverseiterator at 0x10840f490&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">nums</span><span class="p">)</span>
<span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">StopIteration</span><span class="g g-Whitespace">                             </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">7</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>

<span class="ne">StopIteration</span>: 
</pre></div>
</div>
</div>
</div>
<p>When used in a loop, <code class="docutils literal notranslate"><span class="pre">StopIteration</span> <span class="pre">&lt;exceptions.StopIteration&gt;</span></code> is
swallowed and causes the loop to finish. But with explicit invocation,
we can see that once the iterator is exhausted, accessing it raises an
exception.</p>
<p>Using the <code class="docutils literal notranslate"><span class="pre">for..in</span></code> loop also uses the <code class="docutils literal notranslate"><span class="pre">__iter__</span></code>
method. This allows us to transparently start the iteration over a
sequence. But if we already have the iterator, we want to be able to
use it in an <code class="docutils literal notranslate"><span class="pre">for</span></code> loop in the same way. In order to achieve this,
iterators in addition to <code class="docutils literal notranslate"><span class="pre">next</span></code> are also required to have a method
called <code class="docutils literal notranslate"><span class="pre">__iter__</span></code> which returns the iterator (<code class="docutils literal notranslate"><span class="pre">self</span></code>).</p>
<p>Support for iteration is pervasive in Python:
all sequences and unordered containers in the standard library allow
this. The concept is also stretched to other things:
e.g. <code class="docutils literal notranslate"><span class="pre">file</span></code> objects support iteration over lines.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/etc/fstab&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
     <span class="k">assert</span> <span class="n">f</span> <span class="ow">is</span> <span class="n">f</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">file</span></code> is an iterator itself and its <code class="docutils literal notranslate"><span class="pre">__iter__</span></code> method doesn’t create
a separate object: only a single thread of sequential access is allowed.</p>
</section>
<section id="generator-expressions">
<h3>Generator expressions<a class="headerlink" href="#generator-expressions" title="Link to this heading">#</a></h3>
<p>A second way in which iterator objects are created is through
<strong>generator expressions</strong>, the basis for <strong>list comprehensions</strong>. To
increase clarity, a generator expression must always be enclosed in
parentheses or an expression. If round parentheses are used, then a
generator iterator is created. If rectangular parentheses are used,
the process is short-circuited and we get a <code class="docutils literal notranslate"><span class="pre">list</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nums</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;generator object &lt;genexpr&gt; at 0x108129a80&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nums</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 3]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">list</span><span class="p">(</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nums</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[1, 2, 3]
</pre></div>
</div>
</div>
</div>
<p>The list comprehension syntax also extends to
<strong>dictionary and set comprehensions</strong>.
A <code class="docutils literal notranslate"><span class="pre">set</span></code> is created when the generator expression is enclosed in curly
braces. A <code class="docutils literal notranslate"><span class="pre">dict</span></code> is created when the generator expression contains
“pairs” of the form <code class="docutils literal notranslate"><span class="pre">key:value</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{0, 1, 2}
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{0: 0, 1: 1, 2: 4}
</pre></div>
</div>
</div>
</div>
<p>One <em>gotcha</em> should be mentioned: in old Pythons the index variable
(<code class="docutils literal notranslate"><span class="pre">i</span></code>) would leak, and in versions &gt;= 3 this is fixed.</p>
</section>
<section id="generators">
<h3>Generators<a class="headerlink" href="#generators" title="Link to this heading">#</a></h3>
<aside class="sidebar">
<p class="sidebar-title">Generators</p>
<p>A generator is a function that produces a
sequence of results instead of a single value.</p>
<blockquote>
<div><p><em>David Beazley</em> — <a class="reference external" href="https://www.dabeaz.com/coroutines/">A Curious Course on Coroutines and Concurrency</a></p>
</div></blockquote>
</aside>
<p>A third way to create iterator objects is to call a generator function.
A <strong>generator</strong> is a function containing the keyword <code class="docutils literal notranslate"><span class="pre">yield</span></code>. It must be
noted that the mere presence of this keyword completely changes the
nature of the function: this <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement doesn’t have to be
invoked, or even reachable, but causes the function to be marked as a
generator. When a normal function is called, the instructions
contained in the body start to be executed. When a generator is
called, the execution stops before the first instruction in the body.
An invocation of a generator function creates a generator object,
adhering to the iterator protocol. As with normal function
invocations, concurrent and recursive invocations are allowed.</p>
<p>When <code class="docutils literal notranslate"><span class="pre">next</span></code> is called, the function is executed until the first <code class="docutils literal notranslate"><span class="pre">yield</span></code>.
Each encountered <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement gives a value becomes the return
value of <code class="docutils literal notranslate"><span class="pre">next</span></code>. After executing the <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement, the
execution of this function is suspended.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">():</span>
    <span class="k">yield</span> <span class="mi">1</span>
    <span class="k">yield</span> <span class="mi">2</span>

<span class="n">f</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;generator object f at 0x108a047d0&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gen</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
<span class="nb">next</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">next</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">next</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">StopIteration</span><span class="g g-Whitespace">                             </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="nb">next</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>

<span class="ne">StopIteration</span>: 
</pre></div>
</div>
</div>
</div>
<p>Let’s go over the life of the single invocation of the generator
function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">f</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-- start --&quot;</span><span class="p">)</span>
    <span class="k">yield</span> <span class="mi">3</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-- finish --&quot;</span><span class="p">)</span>
    <span class="k">yield</span> <span class="mi">4</span>

<span class="n">gen</span> <span class="o">=</span> <span class="n">f</span><span class="p">()</span>
<span class="nb">next</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-- start --
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>3
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">next</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-- finish --
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4
</pre></div>
</div>
</div>
</div>
<div class="cell tag_raises-exception docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">next</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">StopIteration</span><span class="g g-Whitespace">                             </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">19</span><span class="p">],</span> <span class="n">line</span> <span class="mi">1</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="nb">next</span><span class="p">(</span><span class="n">gen</span><span class="p">)</span>

<span class="ne">StopIteration</span>: 
</pre></div>
</div>
</div>
</div>
<p>Contrary to a normal function, where executing <code class="docutils literal notranslate"><span class="pre">f()</span></code> would
immediately cause the first <code class="docutils literal notranslate"><span class="pre">print</span></code> to be executed, <code class="docutils literal notranslate"><span class="pre">gen</span></code> is
assigned without executing any statements in the function body. Only
when <code class="docutils literal notranslate"><span class="pre">gen.__next__()</span></code> is invoked by <code class="docutils literal notranslate"><span class="pre">next</span></code>, the statements up to
the first <code class="docutils literal notranslate"><span class="pre">yield</span></code> are executed. The second <code class="docutils literal notranslate"><span class="pre">next</span></code> prints
<code class="docutils literal notranslate"><span class="pre">--</span> <span class="pre">finish</span> <span class="pre">--</span></code> and execution halts on the second <code class="docutils literal notranslate"><span class="pre">yield</span></code>. The third
<code class="docutils literal notranslate"><span class="pre">next</span></code> falls of the end of the function.
Since no <code class="docutils literal notranslate"><span class="pre">yield</span></code> was reached, an exception is raised.</p>
<p>What happens with the function after a yield, when the control passes
to the caller? The state of each generator is stored in the generator
object. From the point of view of the generator function, is looks
almost as if it was running in a separate thread, but this is just an
illusion: execution is strictly single-threaded, but the interpreter
keeps and restores the state in between the requests for the next value.</p>
<p>Why are generators useful? As noted in the parts about iterators, a
generator function is just a different way to create an iterator
object. Everything that can be done with <code class="docutils literal notranslate"><span class="pre">yield</span></code> statements, could
also be done with <code class="docutils literal notranslate"><span class="pre">next</span></code> methods. Nevertheless, using a
function and having the interpreter perform its magic to create an
iterator has advantages. A function can be much shorter
than the definition of a class with the required <code class="docutils literal notranslate"><span class="pre">next</span></code> and
<code class="docutils literal notranslate"><span class="pre">__iter__</span></code> methods. What is more important, it is easier for the author
of the generator to understand the state which is kept in local
variables, as opposed to instance attributes, which have to be
used to pass data between consecutive invocations of <code class="docutils literal notranslate"><span class="pre">next</span></code> on
an iterator object.</p>
<p>A broader question is why are iterators useful? When an iterator is
used to power a loop, the loop becomes very simple. The code to
initialise the state, to decide if the loop is finished, and to find
the next value is extracted into a separate place. This highlights the
body of the loop — the interesting part. In addition, it is possible
to reuse the iterator code in other places.</p>
</section>
<section id="bidirectional-communication">
<h3>Bidirectional communication<a class="headerlink" href="#bidirectional-communication" title="Link to this heading">#</a></h3>
<p>Each <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement causes a value to be passed to the
caller. This is the reason for the introduction of generators
by <span class="target" id="index-0"></span><a class="pep reference external" href="https://peps.python.org/pep-0255/"><strong>PEP 255</strong></a>. But communication in the
reverse direction is also useful. One obvious way would be some
external state, either a global variable or a shared mutable
object. Direct communication is possible thanks to <span class="target" id="index-1"></span><a class="pep reference external" href="https://peps.python.org/pep-0342/"><strong>PEP 342</strong></a>.
It is achieved by turning the previously boring
<code class="docutils literal notranslate"><span class="pre">yield</span></code> statement into an expression. When the generator resumes
execution after a <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement, the caller can call a method on
the generator object to either pass a value <strong>into</strong> the generator,
which then is returned by the <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement, or a
different method to inject an exception into the generator.</p>
<p>The first of the new methods is <code class="docutils literal notranslate"><span class="pre">send(value)</span> <span class="pre">&lt;generator.send&gt;</span></code>, which
is similar to <code class="docutils literal notranslate"><span class="pre">next()</span> <span class="pre">&lt;generator.next&gt;</span></code>, but passes <code class="docutils literal notranslate"><span class="pre">value</span></code> into
the generator to be used for the value of the <code class="docutils literal notranslate"><span class="pre">yield</span></code> expression. In
fact, <code class="docutils literal notranslate"><span class="pre">g.next()</span></code> and <code class="docutils literal notranslate"><span class="pre">g.send(None)</span></code> are equivalent.</p>
<p>The second of the new methods is
<code class="docutils literal notranslate"><span class="pre">throw(type,</span> <span class="pre">value=None,</span> <span class="pre">traceback=None)</span> <span class="pre">&lt;generator.throw&gt;</span></code>
which is equivalent to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">raise</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span>
</pre></div>
</div>
<p>at the point of the <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement.</p>
<p>Unlike <code class="docutils literal notranslate"><span class="pre">raise</span></code> (which immediately raises an exception from the
current execution point), <code class="docutils literal notranslate"><span class="pre">throw()</span></code> first resumes the generator, and
only then raises the exception. The word throw was picked because
it is suggestive of putting the exception in another location, and is
associated with exceptions in other languages.</p>
<p>What happens when an exception is raised inside the generator? It can
be either raised explicitly or when executing some statements or it
can be injected at the point of a <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement by means of the
<code class="docutils literal notranslate"><span class="pre">throw()</span></code> method. In either case, such an exception propagates in the
standard manner: it can be intercepted by an <code class="docutils literal notranslate"><span class="pre">except</span></code> or <code class="docutils literal notranslate"><span class="pre">finally</span></code>
clause, or otherwise it causes the execution of the generator function
to be aborted and propagates in the caller.</p>
<p>For completeness’ sake, it’s worth mentioning that generator iterators
also have a <code class="docutils literal notranslate"><span class="pre">close()</span> <span class="pre">&lt;generator.close&gt;</span></code> method, which can be used to
force a generator that would otherwise be able to provide more values
to finish immediately. It allows the generator <code class="docutils literal notranslate"><span class="pre">__del__</span> <span class="pre">&lt;object.__del__&gt;</span></code>
method to destroy objects holding the state of generator.
Let’s define a generator which just prints what is passed in through
send and throw.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">itertools</span>

<span class="k">def</span><span class="w"> </span><span class="nf">g</span><span class="p">():</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--start--&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">itertools</span><span class="o">.</span><span class="n">count</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--yielding </span><span class="si">%i</span><span class="s1">--&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="k">yield</span> <span class="n">i</span>
        <span class="k">except</span> <span class="ne">GeneratorExit</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--closing--&#39;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--yield raised </span><span class="si">%r</span><span class="s1">--&#39;</span> <span class="o">%</span> <span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;--yield returned </span><span class="si">%s</span><span class="s1">--&#39;</span> <span class="o">%</span> <span class="n">ans</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">it</span> <span class="o">=</span> <span class="n">g</span><span class="p">()</span>
<span class="nb">next</span><span class="p">(</span><span class="n">it</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--start--
--yielding 0--
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">it</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="mi">11</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--yield returned 11--
--yielding 1--
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">it</span><span class="o">.</span><span class="n">throw</span><span class="p">(</span><span class="ne">IndexError</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--yield raised IndexError()--
--yielding 2--
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">it</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--closing--
</pre></div>
</div>
</div>
</div>
</section>
<section id="chaining-generators">
<h3>Chaining generators<a class="headerlink" href="#chaining-generators" title="Link to this heading">#</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is a preview of <span class="target" id="index-2"></span><a class="pep reference external" href="https://peps.python.org/pep-0380/"><strong>PEP 380</strong></a> (not yet implemented, but accepted
for Python 3.3).</p>
</div>
<p>Let’s say we are writing a generator and we want to yield a number of
values generated by a second generator, a <strong>subgenerator</strong>.
If yielding of values is the only concern, this can be performed
without much difficulty using a loop such as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">subgen</span> <span class="o">=</span> <span class="n">some_other_generator</span><span class="p">()</span>
<span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">subgen</span><span class="p">:</span>
    <span class="k">yield</span> <span class="n">v</span>
</pre></div>
</div>
<p>However, if the subgenerator is to interact properly with the caller
in the case of calls to <code class="docutils literal notranslate"><span class="pre">send()</span></code>, <code class="docutils literal notranslate"><span class="pre">throw()</span></code> and <code class="docutils literal notranslate"><span class="pre">close()</span></code>,
things become considerably more difficult. The <code class="docutils literal notranslate"><span class="pre">yield</span></code> statement has
to be guarded by a <code class="docutils literal notranslate"><span class="pre">try..except..finally</span></code> structure
similar to the one defined in the previous section to “debug” the
generator function. Such code is provided in <span class="target" id="index-3"></span><a class="pep reference external" href="https://peps.python.org/pep-0380/#id13"><strong>PEP 380#id13</strong></a>, here it
suffices to say that new syntax to properly yield from a subgenerator
is being introduced in Python 3.3:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">yield from</span> <span class="n">some_other_generator</span><span class="p">()</span>
</pre></div>
</div>
<p>This behaves like the explicit loop above, repeatedly yielding values
from <code class="docutils literal notranslate"><span class="pre">some_other_generator</span></code> until it is exhausted, but also forwards
<code class="docutils literal notranslate"><span class="pre">send</span></code>, <code class="docutils literal notranslate"><span class="pre">throw</span></code> and <code class="docutils literal notranslate"><span class="pre">close</span></code> to the subgenerator.</p>
</section>
</section>
<section id="decorators">
<h2>Decorators<a class="headerlink" href="#decorators" title="Link to this heading">#</a></h2>
<aside class="sidebar">
<p class="sidebar-title">Summary</p>
<p>This amazing feature appeared in the language almost apologetically
and with concern that it might not be that useful.</p>
<blockquote>
<div><p><em>Bruce Eckel</em> — An Introduction to Python Decorators</p>
</div></blockquote>
</aside>
<p>Since functions and classes are objects, they can be passed
around. Since they are mutable objects, they can be modified. The act
of altering a function or class object after it has been constructed
but before is is bound to its name is called decorating.</p>
<p>There are two things hiding behind the name “decorator” — one is the
function which does the work of decorating, i.e. performs the real
work, and the other one is the expression adhering to the decorator
syntax, i.e. an at-symbol and the name of the decorating function.</p>
<p>Function can be decorated by using the decorator syntax for
functions:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@decorator</span>             <span class="c1"># ②</span>
<span class="k">def</span><span class="w"> </span><span class="nf">function</span><span class="p">():</span>        <span class="c1"># ①</span>
    <span class="k">pass</span>
</pre></div>
</div>
<ul class="simple">
<li><p>A function is defined in the standard way. ①</p></li>
<li><p>An expression starting with <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> placed before the function
definition is the decorator ②. The part after <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> must be a simple
expression, usually this is just the name of a function or class. This
part is evaluated first, and after the function defined below is
ready, the decorator is called with the newly defined function object
as the single argument. The value returned by the decorator is
attached to the original name of the function.</p></li>
</ul>
<p>Decorators can be applied to functions and to classes. For
classes the semantics are identical — the original class definition
is used as an argument to call the decorator and whatever is returned
is assigned under the original name.</p>
<p>Before the decorator syntax was implemented (<span class="target" id="index-4"></span><a class="pep reference external" href="https://peps.python.org/pep-0318/"><strong>PEP 318</strong></a>), it was
possible to achieve the same effect by assigning the function or class
object to a temporary variable and then invoking the decorator
explicitly and then assigning the return value to the name of the
function. This sounds like more typing, and it is, and also the name of
the decorated function doubling as a temporary variable must be used
at least three times, which is prone to errors. Nevertheless, the
example above is equivalent to:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">function</span><span class="p">():</span>                  <span class="c1"># ①</span>
    <span class="k">pass</span>
<span class="n">function</span> <span class="o">=</span> <span class="n">decorator</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>   <span class="c1"># ②</span>
</pre></div>
</div>
<p>Decorators can be stacked — the order of application is
bottom-to-top, or inside-out. The semantics are such that the originally
defined function is used as an argument for the first decorator,
whatever is returned by the first decorator is used as an argument for
the second decorator, …, and whatever is returned by the last
decorator is attached under the name of the original function.</p>
<p>The decorator syntax was chosen for its readability. Since the
decorator is specified before the header of the function, it is
obvious that its is not a part of the function body and its clear that
it can only operate on the whole function. Because the expression is
prefixed with <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> is stands out and is hard to miss (“in your face”,
according to the PEP :) ). When more than one decorator is applied,
each one is placed on a separate line in an easy to read way.</p>
<section id="replacing-or-tweaking-the-original-object">
<h3>Replacing or tweaking the original object<a class="headerlink" href="#replacing-or-tweaking-the-original-object" title="Link to this heading">#</a></h3>
<p>Decorators can either return the same function or class object or they
can return a completely different object. In the first case, the
decorator can exploit the fact that function and class objects are
mutable and add attributes, e.g. add a docstring to a class. A
decorator might do something useful even without modifying the object,
for example register the decorated class in a global registry. In the
second case, virtually anything is possible: when something
different is substituted for the original function or class, the new
object can be completely different. Nevertheless, such behaviour is
not the purpose of decorators: they are intended to tweak the
decorated object, not do something unpredictable. Therefore, when a
function is “decorated” by replacing it with a different function, the
new function usually calls the original function, after doing some
preparatory work. Likewise, when a class is “decorated” by replacing
if with a new class, the new class is usually derived from the
original class. When the purpose of the decorator is to do something
“every time”, like to log every call to a decorated function, only the
second type of decorators can be used. On the other hand, if the first
type is sufficient, it is better to use it, because it is simpler.</p>
</section>
<section id="decorators-implemented-as-classes-and-as-functions">
<h3>Decorators implemented as classes and as functions<a class="headerlink" href="#decorators-implemented-as-classes-and-as-functions" title="Link to this heading">#</a></h3>
<p>The only <em>requirement</em> on decorators is that they can be called with a
single argument. This means that decorators can be implemented as
normal functions, or as classes with a <code class="docutils literal notranslate"><span class="pre">__call__</span> <span class="pre">&lt;object.__call__&gt;</span></code>
method, or in theory, even as lambda functions.</p>
<p>Let’s compare the function and class approaches. The decorator
expression (the part after <code class="docutils literal notranslate"><span class="pre">&#64;</span></code>) can be either just a name, or a
call. The bare-name approach is nice (less to type, looks cleaner,
etc.), but is only possible when no arguments are needed to customise
the decorator. Decorators written as functions can be used in those
two cases:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">simple_decorator</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;doing decoration&quot;</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">function</span>
<span class="nd">@simple_decorator</span>
<span class="k">def</span><span class="w"> </span><span class="nf">function</span><span class="p">():</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inside function&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>doing decoration
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">function</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>inside function
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">decorator_with_arguments</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;defining the decorator&quot;</span><span class="p">)</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">_decorator</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
      <span class="c1"># in this inner function, arg is available too</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;doing decoration, </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">function</span>
  <span class="k">return</span> <span class="n">_decorator</span>
<span class="nd">@decorator_with_arguments</span><span class="p">(</span><span class="s2">&quot;abc&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">function</span><span class="p">():</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inside function&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>defining the decorator
doing decoration, &#39;abc&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">function</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>inside function
</pre></div>
</div>
</div>
</div>
<p>The two trivial decorators above fall into the category of decorators
which return the original function. If they were to return a new
function, an extra level of nestedness would be required.
In the worst case, three levels of nested functions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">replacing_decorator_with_args</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;defining the decorator&quot;</span><span class="p">)</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">_decorator</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
      <span class="c1"># in this inner function, arg is available too</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;doing decoration, </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span>
      <span class="k">def</span><span class="w"> </span><span class="nf">_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
          <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inside wrapper, </span><span class="si">%r</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
          <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">_wrapper</span>
  <span class="k">return</span> <span class="n">_decorator</span>
<span class="nd">@replacing_decorator_with_args</span><span class="p">(</span><span class="s2">&quot;abc&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inside function, </span><span class="si">%r</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
    <span class="k">return</span> <span class="mi">14</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>defining the decorator
doing decoration, &#39;abc&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">function</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>inside wrapper, (11, 12) {}
inside function, (11, 12) {}
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>14
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">_wrapper</span></code> function is defined to accept all positional and
keyword arguments. In general we cannot know what arguments the
decorated function is supposed to accept, so the wrapper function
just passes everything to the wrapped function. One unfortunate
consequence is that the apparent argument list is misleading.</p>
<p>Compared to decorators defined as functions, complex decorators
defined as classes are simpler. When an object is created, the
<code class="docutils literal notranslate"><span class="pre">__init__</span> <span class="pre">&lt;object.__init__&gt;</span></code> method is only allowed to return <code class="docutils literal notranslate"><span class="pre">None</span></code>,
and the type of the created object cannot be changed. This means that
when a decorator is defined as a class, it doesn’t make much sense to
use the argument-less form: the final decorated object would just be
an instance of the decorating class, returned by the constructor call,
which is not very useful. Therefore it’s enough to discuss class-based
decorators where arguments are given in the decorator expression and
the decorator <code class="docutils literal notranslate"><span class="pre">__init__</span></code> method is used for decorator construction.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">decorator_class</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
      <span class="c1"># this method is called in the decorator expression</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;in decorator init, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span>
  <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
      <span class="c1"># this method is called to do the job</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;in decorator call, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">function</span>
<span class="n">deco_instance</span> <span class="o">=</span> <span class="n">decorator_class</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>in decorator init, foo
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@deco_instance</span>
<span class="k">def</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;in function, </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>in decorator call, foo
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">function</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>in function, () {}
</pre></div>
</div>
</div>
</div>
<p>Contrary to normal rules (<span class="target" id="index-5"></span><a class="pep reference external" href="https://peps.python.org/pep-0008/"><strong>PEP 8</strong></a>) decorators written as classes
behave more like functions and therefore their name often starts with a
lowercase letter.</p>
<p>In reality, it doesn’t make much sense to create a new class just to
have a decorator which returns the original function. Objects are
supposed to hold state, and such decorators are more useful when the
decorator returns a new object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">replacing_decorator_class</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg</span><span class="p">):</span>
      <span class="c1"># this method is called in the decorator expression</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;in decorator init, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span>
  <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">function</span><span class="p">):</span>
      <span class="c1"># this method is called to do the job</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;in decorator call, </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">function</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrapper</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;in the wrapper, </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
      <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="n">deco_instance</span> <span class="o">=</span> <span class="n">replacing_decorator_class</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>in decorator init, foo
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@deco_instance</span>
<span class="k">def</span><span class="w"> </span><span class="nf">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;in function, </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>in decorator call, foo
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">function</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>in the wrapper, (11, 12) {}
in function, (11, 12) {}
</pre></div>
</div>
</div>
</div>
<p>A decorator like this can do pretty much anything, since it can modify
the original function object and mangle the arguments, call the
original function or not, and afterwards mangle the return value.</p>
</section>
<section id="copying-the-docstring-and-other-attributes-of-the-original-function">
<h3>Copying the docstring and other attributes of the original function<a class="headerlink" href="#copying-the-docstring-and-other-attributes-of-the-original-function" title="Link to this heading">#</a></h3>
<p>When a new function is returned by the decorator to replace the
original function, an unfortunate consequence is that the original
function name, the original docstring, the original argument list are
lost. Those attributes of the original function can partially be “transplanted”
to the new function by setting <code class="docutils literal notranslate"><span class="pre">__doc__</span></code> (the docstring), <code class="docutils literal notranslate"><span class="pre">__module__</span></code>
and <code class="docutils literal notranslate"><span class="pre">__name__</span></code> (the full name of the function), and
<code class="docutils literal notranslate"><span class="pre">__annotations__</span></code> (extra information about arguments and the return
value of the function available in Python 3). This can be done
automatically by using <code class="docutils literal notranslate"><span class="pre">functools.update_wrapper</span></code>.</p>
<div class="admonition-functools-update-wrapper-wrapper-wrapped-functools-update-wrapper admonition">
<p class="admonition-title"><code class="docutils literal notranslate"><span class="pre">functools.update_wrapper(wrapper,</span> <span class="pre">wrapped)</span> <span class="pre">&lt;functools.update_wrapper&gt;</span></code></p>
<p>“Update a wrapper function to look like the wrapped function.”</p>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">functools</span>
<span class="k">def</span><span class="w"> </span><span class="nf">replacing_decorator_with_args</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
  <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;defining the decorator&quot;</span><span class="p">)</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">_decorator</span><span class="p">(</span><span class="n">function</span><span class="p">):</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;doing decoration, </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">arg</span><span class="p">)</span>
      <span class="k">def</span><span class="w"> </span><span class="nf">_wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
          <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inside wrapper, </span><span class="si">%r</span><span class="s2"> </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">))</span>
          <span class="k">return</span> <span class="n">function</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">update_wrapper</span><span class="p">(</span><span class="n">_wrapper</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">_decorator</span>
<span class="nd">@replacing_decorator_with_args</span><span class="p">(</span><span class="s2">&quot;abc&quot;</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">function</span><span class="p">():</span>
    <span class="s2">&quot;extensive documentation&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;inside function&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">14</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>defining the decorator
doing decoration, &#39;abc&#39;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">function</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;function __main__.function()&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">function</span><span class="o">.</span><span class="vm">__doc__</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>extensive documentation
</pre></div>
</div>
</div>
</div>
<div class="docutils">
<p>One important thing is missing from the list of attributes which can
be copied to the replacement function: the argument list. The default
values for arguments can be modified through the <code class="docutils literal notranslate"><span class="pre">__defaults__</span></code>,
<code class="docutils literal notranslate"><span class="pre">__kwdefaults__</span></code> attributes, but unfortunately the argument list
itself cannot be set as an attribute. This means that
<code class="docutils literal notranslate"><span class="pre">help(function)</span></code> will display a useless argument list which will be
confusing for the user of the function. An effective but ugly way
around this problem is to create the wrapper dynamically, using
<code class="docutils literal notranslate"><span class="pre">eval</span></code>. This can be automated by using the external <code class="docutils literal notranslate"><span class="pre">decorator</span></code>
module. It provides support for the <code class="docutils literal notranslate"><span class="pre">decorator</span></code> decorator, which takes a
wrapper and turns it into a decorator which preserves the function
signature.</p>
<p>To sum things up, decorators should always use <code class="docutils literal notranslate"><span class="pre">functools.update_wrapper</span></code>
or some other means of copying function attributes.</p>
<h3 class="rubric" id="examples-in-the-standard-library">Examples in the standard library</h3>
<p>First, it should be mentioned that there’s a number of useful
decorators available in the standard library. There are three decorators
which really form a part of the language:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">classmethod</span></code> causes a method to become a “class method”,
which means that it can be invoked without creating an instance of
the class. When a normal method is invoked, the interpreter inserts
the instance object as the first positional parameter,
<code class="docutils literal notranslate"><span class="pre">self</span></code>. When a class method is invoked, the class itself is given
as the first parameter, often called <code class="docutils literal notranslate"><span class="pre">cls</span></code>.</p>
<p>Class methods are still accessible through the class’ namespace, so
they don’t pollute the module’s namespace. Class methods can be used
to provide alternative constructors:</p>
</li>
</ul>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>  <span class="k">class</span><span class="w"> </span><span class="nc">Array</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
      <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">data</span>

      <span class="nd">@classmethod</span>
      <span class="k">def</span><span class="w"> </span><span class="nf">fromfile</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file</span><span class="p">):</span>
          <span class="n">data</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">file</span><span class="p">)</span>
          <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>This is cleaner than using a multitude of flags to <code class="docutils literal notranslate"><span class="pre">__init__</span></code>.</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">staticmethod</span></code> is applied to methods to make them “static”,
i.e. basically a normal function, but accessible through the class
namespace. This can be useful when the function is only needed
inside this class (its name would then be prefixed with <code class="docutils literal notranslate"><span class="pre">_</span></code>), or when we
want the user to think of the method as connected to the class,
despite an implementation which doesn’t require this.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">property</span></code> is the pythonic answer to the problem of getters
and setters. A method decorated with <code class="docutils literal notranslate"><span class="pre">property</span></code> becomes a getter
which is automatically called on attribute access.</p></li>
</ul>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">A</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="nd">@property</span>
  <span class="k">def</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="s2">&quot;an important attribute&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;a value&quot;</span>
<span class="n">A</span><span class="o">.</span><span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;property at 0x108a331f0&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">A</span><span class="p">()</span><span class="o">.</span><span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&#39;a value&#39;
</pre></div>
</div>
</div>
</div>
<p>In this example, <code class="docutils literal notranslate"><span class="pre">A.a</span></code> is an read-only attribute. It is also
documented: <code class="docutils literal notranslate"><span class="pre">help(A)</span></code> includes the docstring for attribute <code class="docutils literal notranslate"><span class="pre">a</span></code>
taken from the getter method. Defining <code class="docutils literal notranslate"><span class="pre">a</span></code> as a property allows it
to be a calculated on the fly, and has the side effect of making it
read-only, because no setter is defined.</p>
<p>To have a setter and a getter, two methods are required,
obviously:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span>  <span class="k">class</span><span class="w"> </span><span class="nc">Rectangle</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
      <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edge</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">edge</span> <span class="o">=</span> <span class="n">edge</span>

      <span class="nd">@property</span>
      <span class="k">def</span><span class="w"> </span><span class="nf">area</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">          </span><span class="sd">&quot;&quot;&quot;Computed area.</span>

<span class="sd">          Setting this updates the edge length to the proper value.</span>
<span class="sd">          &quot;&quot;&quot;</span>
          <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">edge</span><span class="o">**</span><span class="mi">2</span>

      <span class="nd">@area</span><span class="o">.</span><span class="n">setter</span>
      <span class="k">def</span><span class="w"> </span><span class="nf">area</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">area</span><span class="p">):</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">edge</span> <span class="o">=</span> <span class="n">area</span> <span class="o">**</span> <span class="mf">0.5</span>
</pre></div>
</div>
</div>
</div>
<p>The way that this works, is that the <code class="docutils literal notranslate"><span class="pre">property</span></code> decorator replaces
the getter method with a property object. This object in turn has
three methods, <code class="docutils literal notranslate"><span class="pre">getter</span></code>, <code class="docutils literal notranslate"><span class="pre">setter</span></code>, and <code class="docutils literal notranslate"><span class="pre">deleter</span></code>, which can be
used as decorators. Their job is to set the getter, setter and
deleter of the property object (stored as attributes <code class="docutils literal notranslate"><span class="pre">fget</span></code>,
<code class="docutils literal notranslate"><span class="pre">fset</span></code>, and <code class="docutils literal notranslate"><span class="pre">fdel</span></code>). The getter can be set like in the example
above, when creating the object. When defining the setter, we
already have the property object under <code class="docutils literal notranslate"><span class="pre">area</span></code>, and we add the
setter to it by using the <code class="docutils literal notranslate"><span class="pre">setter</span></code> method. All this happens when
we are creating the class.</p>
<p>Afterwards, when an instance of the class has been created, the
property object is special. When the interpreter executes attribute
access, assignment, or deletion, the job is delegated to the methods
of the property object.</p>
<p>To make everything crystal clear, let’s define a “debug” example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">D</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
   <span class="nd">@property</span>
   <span class="k">def</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
     <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;getting 1&quot;</span><span class="p">)</span>
     <span class="k">return</span> <span class="mi">1</span>
   <span class="nd">@a</span><span class="o">.</span><span class="n">setter</span>
   <span class="k">def</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
     <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;setting </span><span class="si">%r</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">value</span><span class="p">)</span>
   <span class="nd">@a</span><span class="o">.</span><span class="n">deleter</span>
   <span class="k">def</span><span class="w"> </span><span class="nf">a</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
     <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;deleting&quot;</span><span class="p">)</span>
<span class="n">D</span><span class="o">.</span><span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;property at 0x108a74900&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">D</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">fget</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;function __main__.D.a(self)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">D</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">fset</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;function __main__.D.a(self, value)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">D</span><span class="o">.</span><span class="n">a</span><span class="o">.</span><span class="n">fdel</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>&lt;function __main__.D.a(self)&gt;
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span> <span class="o">=</span> <span class="n">D</span><span class="p">()</span>               <span class="c1"># ... varies, this is not the same `a` function</span>
<span class="n">d</span><span class="o">.</span><span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>getting 1
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="o">.</span><span class="n">a</span> <span class="o">=</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>setting 2
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">del</span> <span class="n">d</span><span class="o">.</span><span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>deleting
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">d</span><span class="o">.</span><span class="n">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>getting 1
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1
</pre></div>
</div>
</div>
</div>
<p>Properties are a bit of a stretch for the decorator syntax. One of the
premises of the decorator syntax — that the name is not duplicated
— is violated, but nothing better has been invented so far. It is
just good style to use the same name for the getter, setter, and
deleter methods.</p>
<p>Some newer examples include:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">functools.lru_cache</span></code> memoizes an arbitrary function
maintaining a limited cache of arguments:answer pairs (Python 3.2)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">functools.total_ordering</span></code> is a class decorator which fills in
missing ordering methods
(<code class="docutils literal notranslate"><span class="pre">__lt__</span> <span class="pre">&lt;object.__lt__&gt;</span></code>, <code class="docutils literal notranslate"><span class="pre">__gt__</span> <span class="pre">&lt;object.__gt__&gt;</span></code>,
<code class="docutils literal notranslate"><span class="pre">__le__</span> <span class="pre">&lt;object.__le__&gt;</span></code>, …)
based on a single available one.</p></li>
</ul>
<!---
- `packaging.pypi.simple.socket_timeout` (in Python 3.3) adds
a socket timeout when retrieving data through a socket.
-->
</section>
<section id="deprecation-of-functions">
<h3>Deprecation of functions<a class="headerlink" href="#deprecation-of-functions" title="Link to this heading">#</a></h3>
<p>Let’s say we want to print a deprecation warning on stderr on the
first invocation of a function we don’t like anymore. If we don’t want
to modify the function, we can use a decorator:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">deprecated</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print a deprecation warning once on first use of the function.</span>

<span class="sd">    &gt;&gt;&gt; @deprecated()</span>
<span class="sd">    ... def f():</span>
<span class="sd">    ...     pass</span>
<span class="sd">    &gt;&gt;&gt; f()</span>
<span class="sd">    f is deprecated</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_wrapper</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_wrapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;is deprecated&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<!---
TODO: use update_wrapper here
-->
<p>It can also be implemented as a function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">deprecated</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print a deprecation warning once on first use of the function.</span>

<span class="sd">    &gt;&gt;&gt; @deprecated</span>
<span class="sd">    ... def f():</span>
<span class="sd">    ...     pass</span>
<span class="sd">    &gt;&gt;&gt; f()</span>
<span class="sd">    f is deprecated</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">count</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span> <span class="n">count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s1">&#39;is deprecated&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wrapper</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="a-while-loop-removing-decorator">
<h3>A <code class="docutils literal notranslate"><span class="pre">while</span></code>-loop removing decorator<a class="headerlink" href="#a-while-loop-removing-decorator" title="Link to this heading">#</a></h3>
<p>Let’s say we have function which returns a lists of things, and this
list created by running a loop. If we don’t know how many objects will
be needed, the standard way to do this is something like:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">find_answers</span><span class="p">():</span>
    <span class="n">answers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="n">look_for_next_answer</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="n">answers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ans</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">answers</span>
</pre></div>
</div>
</div>
</div>
<p>This is fine, as long as the body of the loop is fairly compact. Once
it becomes more complicated, as often happens in real code, this
becomes pretty unreadable. We could simplify this by using <code class="docutils literal notranslate"><span class="pre">yield</span></code>
statements, but then the user would have to explicitly call
<code class="docutils literal notranslate"><span class="pre">list(find_answers())</span></code>.</p>
<p>We can define a decorator which constructs the list for us:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">vectorized</span><span class="p">(</span><span class="n">generator_func</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">generator_func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">functools</span><span class="o">.</span><span class="n">update_wrapper</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="n">generator_func</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Our function then becomes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@vectorized</span>
<span class="k">def</span><span class="w"> </span><span class="nf">find_answers</span><span class="p">():</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">ans</span> <span class="o">=</span> <span class="n">look_for_next_answer</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">ans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">break</span>
        <span class="k">yield</span> <span class="n">ans</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="a-plugin-registration-system">
<h3>A plugin registration system<a class="headerlink" href="#a-plugin-registration-system" title="Link to this heading">#</a></h3>
<p>This is a class decorator which doesn’t modify the class, but just
puts it in a global registry. It falls into the category of decorators
returning the original object:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">WordProcessor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="n">PLUGINS</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">PLUGINS</span><span class="p">:</span>
            <span class="n">text</span> <span class="o">=</span> <span class="n">plugin</span><span class="p">()</span><span class="o">.</span><span class="n">cleanup</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span>

    <span class="nd">@classmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">plugin</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">plugin</span><span class="p">):</span>
        <span class="bp">cls</span><span class="o">.</span><span class="n">PLUGINS</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plugin</span><span class="p">)</span>

<span class="nd">@WordProcessor</span><span class="o">.</span><span class="n">plugin</span>
<span class="k">class</span><span class="w"> </span><span class="nc">CleanMdashesExtension</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">text</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;&amp;mdash;&#39;</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;</span><span class="se">\N{em dash}</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here we use a decorator to decentralise the registration of
plugins. We call our decorator with a noun, instead of a verb, because
we use it to declare that our class is a plugin for
<code class="docutils literal notranslate"><span class="pre">WordProcessor</span></code>. Method <code class="docutils literal notranslate"><span class="pre">plugin</span></code> simply appends the class to the
list of plugins.</p>
<p>A word about the plugin itself: it replaces HTML entity for em-dash
with a real Unicode em-dash character. It exploits the <a class="reference external" href="https://docs.python.org/3/reference/lexical_analysis.html#string-and-bytes-literals">unicode
literal notation</a> to insert a character by using its name in the
unicode database (“EM DASH”). If the Unicode character was inserted
directly, it would be impossible to distinguish it from an en-dash in
the source of a program.</p>
<div class="admonition-see-also admonition">
<p class="admonition-title">See also</p>
<p><strong>More examples and reading</strong></p>
<ul class="simple">
<li><p><span class="target" id="index-6"></span><a class="pep reference external" href="https://peps.python.org/pep-0318/"><strong>PEP 318</strong></a> (function and method decorator syntax)</p></li>
<li><p><span class="target" id="index-7"></span><a class="pep reference external" href="https://peps.python.org/pep-3129/"><strong>PEP 3129</strong></a> (class decorator syntax)</p></li>
<li><p><a class="reference external" href="https://wiki.python.org/moin/PythonDecoratorLibrary">https://wiki.python.org/moin/PythonDecoratorLibrary</a></p></li>
<li><p><a class="reference external" href="https://docs.python.org/dev/library/functools.html">https://docs.python.org/dev/library/functools.html</a></p></li>
<li><p><a class="reference external" href="https://pypi.org/project/decorator">https://pypi.org/project/decorator</a></p></li>
<li><p>Bruce Eckel</p>
<ul>
<li><p><a class="reference external" href="https://www.artima.com/weblogs/viewpost.jsp?thread=240808">Decorators I</a>: Introduction to Python Decorators</p></li>
<li><p><a class="reference external" href="https://www.artima.com/weblogs/viewpost.jsp?thread=240845">Python Decorators II</a>: Decorator Arguments</p></li>
<li><p><a class="reference external" href="https://www.artima.com/weblogs/viewpost.jsp?thread=241209">Python Decorators III</a>: A Decorator-Based Build System</p></li>
</ul>
</li>
</ul>
</div>
</section>
</section>
<section id="context-managers">
<h2>Context managers<a class="headerlink" href="#context-managers" title="Link to this heading">#</a></h2>
<p>A context manager is an object with <code class="docutils literal notranslate"><span class="pre">__enter__</span> <span class="pre">&lt;object.__enter__&gt;</span></code> and
<code class="docutils literal notranslate"><span class="pre">__exit__</span> <span class="pre">&lt;object.__exit__&gt;</span></code> methods which can be used in the <code class="docutils literal notranslate"><span class="pre">with</span></code> statement:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">manager</span> <span class="k">as</span> <span class="n">var</span><span class="p">:</span>
    <span class="n">do_something</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
</pre></div>
</div>
<p>is in the simplest case</p>
<p>equivalent to</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="fm">__enter__</span><span class="p">()</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">do_something</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">manager</span><span class="o">.</span><span class="fm">__exit__</span><span class="p">()</span>
</pre></div>
</div>
<p>In other words, the context manager protocol defined in <span class="target" id="index-8"></span><a class="pep reference external" href="https://peps.python.org/pep-0343/"><strong>PEP 343</strong></a>
permits the extraction of the boring part of a <code class="docutils literal notranslate"><span class="pre">try..except..finally</span></code> structure
into a separate class leaving only the interesting <code class="docutils literal notranslate"><span class="pre">do_something</span></code> block.</p>
<ol class="arabic simple">
<li><p>The <code class="docutils literal notranslate"><span class="pre">__enter__</span> <span class="pre">&lt;object.__enter__&gt;</span></code> method is called first. It can
return a value which will be assigned to <code class="docutils literal notranslate"><span class="pre">var</span></code>.
The <code class="docutils literal notranslate"><span class="pre">as</span></code>-part is optional: if it isn’t present, the value
returned by <code class="docutils literal notranslate"><span class="pre">__enter__</span></code> is simply ignored.</p></li>
<li><p>The block of code underneath <code class="docutils literal notranslate"><span class="pre">with</span></code> is executed. Just like with
<code class="docutils literal notranslate"><span class="pre">try</span></code> clauses, it can either execute successfully to the end, or
it can <code class="docutils literal notranslate"><span class="pre">break</span></code>, <code class="docutils literal notranslate"><span class="pre">continue</span></code> or <code class="docutils literal notranslate"><span class="pre">return</span></code>, or
it can throw an exception. Either way, after the block is finished,
the <code class="docutils literal notranslate"><span class="pre">__exit__</span> <span class="pre">&lt;object.__exit__&gt;</span></code> method is called.
If an exception was thrown, the information about the exception is
passed to <code class="docutils literal notranslate"><span class="pre">__exit__</span></code>, which is described below in the next
subsection. In the normal case, exceptions can be ignored, just
like in a <code class="docutils literal notranslate"><span class="pre">finally</span></code> clause, and will be rethrown after
<code class="docutils literal notranslate"><span class="pre">__exit__</span></code> is finished.</p></li>
</ol>
<p>Let’s say we want to make sure that a file is closed immediately after
we are done writing to it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">closing</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span>
  <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">obj</span>
  <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/tmp/file&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;the contents</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here we have made sure that the <code class="docutils literal notranslate"><span class="pre">f.close()</span></code> is called when the
<code class="docutils literal notranslate"><span class="pre">with</span></code> block is exited. Since closing files is such a common
operation, the support for this is already present in the <code class="docutils literal notranslate"><span class="pre">file</span></code>
class. It has an <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> method which calls <code class="docutils literal notranslate"><span class="pre">close</span></code> and can be
used as a context manager itself:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;/tmp/file&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
  <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;more contents</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The common use for <code class="docutils literal notranslate"><span class="pre">try..finally</span></code> is releasing resources. Various
different cases are implemented similarly: in the <code class="docutils literal notranslate"><span class="pre">__enter__</span></code>
phase the resource is acquired, in the <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> phase it is
released, and the exception, if thrown, is propagated. As with files,
there’s often a natural operation to perform after the object has been
used and it is most convenient to have the support built in. With each
release, Python provides support in more places:</p>
<ul class="simple">
<li><p>all file-like objects:</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">file</span></code> ➔ automatically closed</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">fileinput</span></code>, <code class="docutils literal notranslate"><span class="pre">tempfile</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">bz2.BZ2File</span></code>, <code class="docutils literal notranslate"><span class="pre">gzip.GzipFile</span></code>,
<code class="docutils literal notranslate"><span class="pre">tarfile.TarFile</span></code>, <code class="docutils literal notranslate"><span class="pre">zipfile.ZipFile</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ftplib</span></code>, <code class="docutils literal notranslate"><span class="pre">nntplib</span></code> ➔ close connection</p></li>
</ul>
</li>
<li><p>locks</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">multiprocessing.RLock</span></code> ➔ lock and unlock</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">multiprocessing.Semaphore</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">memoryview</span></code> ➔ automatically release</p></li>
</ul>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">decimal.localcontext</span></code> ➔ modify precision of computations temporarily</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">_winreg.PyHKEY</span> <span class="pre">&lt;_winreg.OpenKey&gt;</span></code> ➔ open and close hive key</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">warnings.catch_warnings</span></code> ➔ kill warnings temporarily</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">contextlib.closing</span></code> ➔ the same as the example above, call <code class="docutils literal notranslate"><span class="pre">close</span></code></p></li>
<li><p>parallel programming</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">concurrent.futures.ThreadPoolExecutor</span></code> ➔ invoke in parallel then kill thread pool</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">concurrent.futures.ProcessPoolExecutor</span></code> ➔ invoke in parallel then kill process pool</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">nogil</span></code> ➔ solve the GIL problem temporarily (cython only :( )</p></li>
</ul>
</li>
</ul>
<section id="catching-exceptions">
<h3>Catching exceptions<a class="headerlink" href="#catching-exceptions" title="Link to this heading">#</a></h3>
<p>When an exception is thrown in the <code class="docutils literal notranslate"><span class="pre">with</span></code>-block, it is passed as
arguments to <code class="docutils literal notranslate"><span class="pre">__exit__</span></code>. Three arguments are used, the same as
returned by <code class="xref py py-func docutils literal notranslate"><span class="pre">sys.exc_info()</span></code>: type, value, traceback. When no
exception is thrown, <code class="docutils literal notranslate"><span class="pre">None</span></code> is used for all three arguments. The
context manager can “swallow” the exception by returning a true value
from <code class="docutils literal notranslate"><span class="pre">__exit__</span></code>. Exceptions can be easily ignored, because if
<code class="docutils literal notranslate"><span class="pre">__exit__</span></code> doesn’t use <code class="docutils literal notranslate"><span class="pre">return</span></code> and just falls of the end,
<code class="docutils literal notranslate"><span class="pre">None</span></code> is returned, a false value, and therefore the exception is
rethrown after <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> is finished.</p>
<p>The ability to catch exceptions opens interesting possibilities. A
classic example comes from unit-tests — we want to make sure that
some code throws the right kind of exception:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">assert_raises</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># based on pytest and unittest.TestCase</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">type</span> <span class="o">=</span> <span class="nb">type</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">def</span><span class="w"> </span><span class="fm">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;exception expected&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">type</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span> <span class="c1"># swallow the expected exception</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;wrong exception type&#39;</span><span class="p">)</span>

<span class="k">with</span> <span class="n">assert_raises</span><span class="p">(</span><span class="ne">KeyError</span><span class="p">):</span>
    <span class="p">{}[</span><span class="s1">&#39;foo&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="using-generators-to-define-context-managers">
<h3>Using generators to define context managers<a class="headerlink" href="#using-generators-to-define-context-managers" title="Link to this heading">#</a></h3>
<p>When discussing [generators], it was said that we prefer generators to
iterators implemented as classes because they are shorter, sweeter,
and the state is stored as local, not instance, variables. On the
other hand, as described in [Bidirectional communication], the flow
of data between the generator and its caller can be bidirectional.
This includes exceptions, which can be thrown into the
generator. We would like to implement context managers as special
generator functions. In fact, the generator protocol was designed to
support this use case.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">some_generator</span><span class="p">(</span><span class="o">&lt;</span><span class="n">arguments</span><span class="o">&gt;</span><span class="p">):</span>
    <span class="o">&lt;</span><span class="n">setup</span><span class="o">&gt;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="o">&lt;</span><span class="n">value</span><span class="o">&gt;</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="o">&lt;</span><span class="n">cleanup</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">contextlib.contextmanager</span></code> helper takes a generator and turns it
into a context manager. The generator has to obey some rules which are
enforced by the wrapper function — most importantly it must
<code class="docutils literal notranslate"><span class="pre">yield</span></code> exactly once. The part before the <code class="docutils literal notranslate"><span class="pre">yield</span></code> is executed from
<code class="docutils literal notranslate"><span class="pre">__enter__</span></code>, the block of code protected by the context manager is
executed when the generator is suspended in <code class="docutils literal notranslate"><span class="pre">yield</span></code>, and the rest is
executed in <code class="docutils literal notranslate"><span class="pre">__exit__</span></code>. If an exception is thrown, the interpreter
hands it to the wrapper through <code class="docutils literal notranslate"><span class="pre">__exit__</span></code> arguments, and the
wrapper function then throws it at the point of the <code class="docutils literal notranslate"><span class="pre">yield</span></code>
statement. Through the use of generators, the context manager is
shorter and simpler.</p>
<p>Let’s rewrite the <code class="docutils literal notranslate"><span class="pre">closing</span></code> example as a generator:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">contextlib</span>

<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">closing</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">obj</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">obj</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s rewrite the <code class="docutils literal notranslate"><span class="pre">assert_raises</span></code> example as a generator:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">assert_raises</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">yield</span>
    <span class="k">except</span> <span class="nb">type</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">value</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;wrong exception type&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">AssertionError</span><span class="p">(</span><span class="s1">&#39;exception expected&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here we use a decorator to turn generator functions into context managers!</p>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./advanced/advanced_python"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Advanced topics</p>
      </div>
    </a>
    <a class="right-next"
       href="../advanced_numpy/index.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Advanced NumPy</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#iterators-generator-expressions-and-generators">Iterators, generator expressions and generators</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#iterators">Iterators</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generator-expressions">Generator expressions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#generators">Generators</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#bidirectional-communication">Bidirectional communication</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#chaining-generators">Chaining generators</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#decorators">Decorators</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#replacing-or-tweaking-the-original-object">Replacing or tweaking the original object</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#decorators-implemented-as-classes-and-as-functions">Decorators implemented as classes and as functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#copying-the-docstring-and-other-attributes-of-the-original-function">Copying the docstring and other attributes of the original function</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#deprecation-of-functions">Deprecation of functions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-while-loop-removing-decorator">A <code class="docutils literal notranslate"><span class="pre">while</span></code>-loop removing decorator</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#a-plugin-registration-system">A plugin registration system</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#context-managers">Context managers</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#catching-exceptions">Catching exceptions</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#using-generators-to-define-context-managers">Using generators to define context managers</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Scientific Python developers
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>