
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Optimizing code &#8212; Scientific Python Lectures</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/exercise.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'advanced/optimizing/index';</script>
    <link rel="canonical" href="https://lectures.scientific-python.org/advanced/optimizing/index.html" />
    <link rel="icon" href="../../_static/sp_lectures.png"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Introduction" href="../scipy_sparse/introduction.html" />
    <link rel="prev" title="Debugging code" href="../debugging/index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/sp_lectures.png" class="logo__image only-light" alt="Scientific Python Lectures - Home"/>
    <script>document.write(`<img src="../../_static/sp_lectures.png" class="logo__image only-dark" alt="Scientific Python Lectures - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting started with Python for Science</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../intro/index.html">Getting started with Python for science</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/intro.html">Python scientific computing ecosystem</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../intro/language/python_language.html">The Python language</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/first_steps.html">First steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/basic_types.html">Basic types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/control_flow.html">Control Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/functions.html">Defining functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/reusing_code.html">Reusing code: scripts and modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/io.html">Input and Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/standard_library.html">Standard Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/exceptions.html">Exception handling in Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/oop.html">Object-oriented programming (OOP)</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../intro/numpy/index.html">NumPy: creating and manipulating numerical data</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../intro/numpy/array_object.html">The NumPy array object</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/numpy/operations.html">Numerical operations on arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/numpy/elaborate_arrays.html">More elaborate arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/numpy/advanced_operations.html">Advanced operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/numpy/exercises.html">Some exercises</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/matplotlib/index.html">Matplotlib: plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/scipy/index.html">SciPy : high-level scientific computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/help/help.html">Getting help and finding documentation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Advanced topics</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Advanced topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_python/index.html">Advanced Python Constructs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_numpy/index.html">Advanced NumPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debugging/index.html">Debugging code</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Optimizing code</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../scipy_sparse/introduction.html">Introduction</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../scipy_sparse/storage_schemes.html">Storage Schemes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scipy_sparse/solvers.html">Linear System Solvers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scipy_sparse/other_packages.html">Other Interesting Packages</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../image_processing/index.html">Image manipulation and processing using NumPy and SciPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mathematical_optimization/index.html">Mathematical optimization: finding minima of functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../interfacing_with_c/interfacing_with_c.html">Interfacing with C</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Packages and applications</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../packages/index.html">Packages and applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages/statistics/index.html">Statistics in Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages/sympy.html">Sympy : Symbolic Mathematics in Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages/scikit-image/index.html"><code class="docutils literal notranslate"><span class="pre">scikit-image</span></code>: image processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages/scikit-learn/index.html">scikit-learn: machine learning in Python</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About the Scientific Python Lectures</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About the Scientific Python Lecture notes</a></li>




</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/scipy-lectures/scientific-python-lectures" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/scipy-lectures/scientific-python-lectures/edit/main/advanced/optimizing/index.Rmd" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/scipy-lectures/scientific-python-lectures/issues/new?title=Issue%20on%20page%20%2Fadvanced/optimizing/index.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/advanced/optimizing/index.Rmd" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.Rmd</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Optimizing code</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optimization-workflow">Optimization workflow</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#profiling-python-code">Profiling Python code</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#timeit">Timeit</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#profiler">Profiler</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#line-profiler">Line-profiler</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#making-code-go-faster">Making code go faster</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#algorithmic-optimization">Algorithmic optimization</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-of-the-svd">Example of the SVD</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#writing-faster-numerical-code">Writing faster numerical code</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#vectorizing-for-loops">Vectorizing for loops</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#broadcasting">Broadcasting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#in-place-operations">In place operations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#be-easy-on-the-memory-use-views-and-not-copies">Be easy on the memory: use views, and not copies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#beware-of-cache-effects">Beware of cache effects</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-compiled-code">Use compiled code</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-links">Additional Links</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="optimizing-code">
<span id="optimizing-code-chapter"></span><h1>Optimizing code<a class="headerlink" href="#optimizing-code" title="Link to this heading">#</a></h1>
<aside class="sidebar">
<p class="sidebar-title">Donald Knuth</p>
<p><em>“Premature optimization is the root of all evil”</em></p>
</aside>
<p><strong>Author</strong>: <em>Gaël Varoquaux</em></p>
<p>This chapter deals with strategies to make Python code go faster.</p>
<div class="admonition-prerequisites admonition">
<p class="admonition-title">Prerequisites</p>
<ul class="simple">
<li><p><a class="reference external" href="https://pypi.org/project/line-profiler/">line_profiler</a></p></li>
</ul>
</div>
<section id="optimization-workflow">
<h2>Optimization workflow<a class="headerlink" href="#optimization-workflow" title="Link to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>Make it work: write the code in a simple <strong>legible</strong> ways.</p></li>
<li><p>Make it work reliably: write automated test cases, make really sure
that your algorithm is right and that if you break it, the tests will
capture the breakage.</p></li>
<li><p>Optimize the code by profiling simple use-cases to find the
bottlenecks and speeding up these bottleneck, finding a better
algorithm or implementation. Keep in mind that a trade off should be
found between profiling on a realistic example and the simplicity and
speed of execution of the code. For efficient work, it is best to work
with profiling runs lasting around 10s.</p></li>
</ol>
</section>
<section id="profiling-python-code">
<h2>Profiling Python code<a class="headerlink" href="#profiling-python-code" title="Link to this heading">#</a></h2>
<div class="admonition-no-optimization-without-measuring admonition">
<p class="admonition-title"><strong>No optimization without measuring!</strong></p>
<ul class="simple">
<li><p><strong>Measure:</strong> profiling, timing</p></li>
<li><p>You’ll have surprises: the fastest code is not always what you think</p></li>
</ul>
</div>
<section id="timeit">
<h3>Timeit<a class="headerlink" href="#timeit" title="Link to this heading">#</a></h3>
<p>In Jupyter or IPython, use <code class="docutils literal notranslate"><span class="pre">timeit</span></code>
(<a class="reference external" href="https://docs.python.org/3/library/timeit.html">https://docs.python.org/3/library/timeit.html</a>) to time elementary
operations:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span>

<span class="o">%</span><span class="k">timeit</span> a ** 2
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>924 ns ± 74.5 ns per loop (mean ± std. dev. of 7 runs, 1,000,000 loops each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> a ** 2.1
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>23.9 μs ± 1.43 μs per loop (mean ± std. dev. of 7 runs, 10,000 loops each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> a * a
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.23 μs ± 274 ns per loop (mean ± std. dev. of 7 runs, 1,000,000 loops each)
</pre></div>
</div>
</div>
</div>
<p>Use this to guide your choice between strategies.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For long running calls, using <code class="docutils literal notranslate"><span class="pre">%time</span></code> instead of <code class="docutils literal notranslate"><span class="pre">%timeit</span></code>; it is
less precise but faster.</p>
</div>
</section>
<section id="profiler">
<h3>Profiler<a class="headerlink" href="#profiler" title="Link to this heading">#</a></h3>
<p>Useful when you have a large program to profile, for example the
<a class="reference download internal" download="" href="../../_downloads/3800cc291e0024d966cd6ee966028f8e/demo.py"><code class="xref download docutils literal notranslate"><span class="pre">following</span> <span class="pre">file</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># For this example to run, you also need the &#39;ica.py&#39; file</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">ica</span><span class="w"> </span><span class="kn">import</span> <span class="n">fastica</span>


<span class="c1"># @profile  # uncomment this line to run with line_profiler</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">():</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">pca</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">data</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">fastica</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">whiten</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">test</span><span class="p">()</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is a combination of two unsupervised learning techniques, principal
component analysis (<a class="reference external" href="https://en.wikipedia.org/wiki/Principal_component_analysis">PCA</a>) and
independent component analysis
(<a class="reference external" href="https://en.wikipedia.org/wiki/Independent_component_analysis">ICA</a>). PCA
is a technique for dimensionality reduction, i.e. an algorithm to explain
the observed variance in your data using less dimensions. ICA is a source
separation technique, for example to unmix multiple signals that have been
recorded through multiple sensors. Doing a PCA first and then an ICA can be
useful if you have more sensors than signals. For more information see:
<a class="reference external" href="https://scikit-learn.org/stable/auto_examples/decomposition/plot_ica_blind_source_separation.html">the FastICA example from scikits-learn</a>.</p>
</div>
<p>To run it, you also need to download the <a class="reference download internal" download="" href="../../_downloads/f221749774c0529207e9b06e14cfb784/ica.py"><code class="xref download docutils literal notranslate"><span class="pre">ica</span> <span class="pre">module</span></code></a>.
In IPython we can time the script:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="o">%</span><span class="n">run</span> <span class="o">-</span><span class="n">t</span> <span class="n">demo</span><span class="o">.</span><span class="n">py</span>
<span class="n">IPython</span> <span class="n">CPU</span> <span class="n">timings</span> <span class="p">(</span><span class="n">estimated</span><span class="p">):</span>
    <span class="n">User</span>  <span class="p">:</span>    <span class="mf">14.3929</span> <span class="n">s</span><span class="o">.</span>
    <span class="n">System</span><span class="p">:</span>   <span class="mf">0.256016</span> <span class="n">s</span><span class="o">.</span>
</pre></div>
</div>
<p>and profile it:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="o">%</span><span class="n">run</span> <span class="o">-</span><span class="n">p</span> <span class="n">demo</span><span class="o">.</span><span class="n">py</span>
        <span class="mi">916</span> <span class="n">function</span> <span class="n">calls</span> <span class="ow">in</span> <span class="mf">14.551</span> <span class="n">CPU</span> <span class="n">seconds</span>
<span class="n">Ordered</span> <span class="n">by</span><span class="p">:</span> <span class="n">internal</span> <span class="n">time</span>
<span class="n">ncalls</span>  <span class="n">tottime</span>  <span class="n">percall</span>  <span class="n">cumtime</span>  <span class="n">percall</span> <span class="n">filename</span><span class="p">:</span><span class="n">lineno</span> <span class="p">(</span><span class="n">function</span><span class="p">)</span>
    <span class="mi">1</span>   <span class="mf">14.457</span>   <span class="mf">14.457</span>   <span class="mf">14.479</span>   <span class="mf">14.479</span> <span class="n">decomp</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">849</span> <span class="p">(</span><span class="n">svd</span><span class="p">)</span>
    <span class="mi">1</span>    <span class="mf">0.054</span>    <span class="mf">0.054</span>    <span class="mf">0.054</span>    <span class="mf">0.054</span> <span class="p">{</span><span class="n">method</span> <span class="s1">&#39;random_sample&#39;</span> <span class="n">of</span> <span class="s1">&#39;mtrand.RandomState&#39;</span> <span class="n">objects</span><span class="p">}</span>
    <span class="mi">1</span>    <span class="mf">0.017</span>    <span class="mf">0.017</span>    <span class="mf">0.021</span>    <span class="mf">0.021</span> <span class="n">function_base</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">645</span> <span class="p">(</span><span class="n">asarray_chkfinite</span><span class="p">)</span>
    <span class="mi">54</span>    <span class="mf">0.011</span>    <span class="mf">0.000</span>    <span class="mf">0.011</span>    <span class="mf">0.000</span> <span class="p">{</span><span class="n">numpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">_dotblas</span><span class="o">.</span><span class="n">dot</span><span class="p">}</span>
    <span class="mi">2</span>    <span class="mf">0.005</span>    <span class="mf">0.002</span>    <span class="mf">0.005</span>    <span class="mf">0.002</span> <span class="p">{</span><span class="n">method</span> <span class="s1">&#39;any&#39;</span> <span class="n">of</span> <span class="s1">&#39;numpy.ndarray&#39;</span> <span class="n">objects</span><span class="p">}</span>
    <span class="mi">6</span>    <span class="mf">0.001</span>    <span class="mf">0.000</span>    <span class="mf">0.001</span>    <span class="mf">0.000</span> <span class="n">ica</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">195</span> <span class="p">(</span><span class="n">gprime</span><span class="p">)</span>
    <span class="mi">6</span>    <span class="mf">0.001</span>    <span class="mf">0.000</span>    <span class="mf">0.001</span>    <span class="mf">0.000</span> <span class="n">ica</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">192</span> <span class="p">(</span><span class="n">g</span><span class="p">)</span>
    <span class="mi">14</span>    <span class="mf">0.001</span>    <span class="mf">0.000</span>    <span class="mf">0.001</span>    <span class="mf">0.000</span> <span class="p">{</span><span class="n">numpy</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lapack_lite</span><span class="o">.</span><span class="n">dsyevd</span><span class="p">}</span>
    <span class="mi">19</span>    <span class="mf">0.001</span>    <span class="mf">0.000</span>    <span class="mf">0.001</span>    <span class="mf">0.000</span> <span class="n">twodim_base</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">204</span> <span class="p">(</span><span class="n">diag</span><span class="p">)</span>
    <span class="mi">1</span>    <span class="mf">0.001</span>    <span class="mf">0.001</span>    <span class="mf">0.008</span>    <span class="mf">0.008</span> <span class="n">ica</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">69</span> <span class="p">(</span><span class="n">_ica_par</span><span class="p">)</span>
    <span class="mi">1</span>    <span class="mf">0.001</span>    <span class="mf">0.001</span>   <span class="mf">14.551</span>   <span class="mf">14.551</span> <span class="p">{</span><span class="n">execfile</span><span class="p">}</span>
    <span class="mi">107</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.001</span>    <span class="mf">0.000</span> <span class="n">defmatrix</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">239</span> <span class="p">(</span><span class="n">__array_finalize__</span><span class="p">)</span>
    <span class="mi">7</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.004</span>    <span class="mf">0.001</span> <span class="n">ica</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">58</span> <span class="p">(</span><span class="n">_sym_decorrelation</span><span class="p">)</span>
    <span class="mi">7</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.002</span>    <span class="mf">0.000</span> <span class="n">linalg</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">841</span> <span class="p">(</span><span class="n">eigh</span><span class="p">)</span>
    <span class="mi">172</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span> <span class="p">{</span><span class="nb">isinstance</span><span class="p">}</span>
    <span class="mi">1</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>   <span class="mf">14.551</span>   <span class="mf">14.551</span> <span class="n">demo</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">1</span> <span class="p">(</span><span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">)</span>
    <span class="mi">29</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span> <span class="n">numeric</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">180</span> <span class="p">(</span><span class="n">asarray</span><span class="p">)</span>
    <span class="mi">35</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span> <span class="n">defmatrix</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">193</span> <span class="p">(</span><span class="fm">__new__</span><span class="p">)</span>
    <span class="mi">35</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.001</span>    <span class="mf">0.000</span> <span class="n">defmatrix</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">43</span> <span class="p">(</span><span class="n">asmatrix</span><span class="p">)</span>
    <span class="mi">21</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.001</span>    <span class="mf">0.000</span> <span class="n">defmatrix</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">287</span> <span class="p">(</span><span class="fm">__mul__</span><span class="p">)</span>
    <span class="mi">41</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span> <span class="p">{</span><span class="n">numpy</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">multiarray</span><span class="o">.</span><span class="n">zeros</span><span class="p">}</span>
    <span class="mi">28</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span> <span class="p">{</span><span class="n">method</span> <span class="s1">&#39;transpose&#39;</span> <span class="n">of</span> <span class="s1">&#39;numpy.ndarray&#39;</span> <span class="n">objects</span><span class="p">}</span>
    <span class="mi">1</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.008</span>    <span class="mf">0.008</span> <span class="n">ica</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">97</span> <span class="p">(</span><span class="n">fastica</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>Clearly the <code class="docutils literal notranslate"><span class="pre">svd</span></code> (in <code class="docutils literal notranslate"><span class="pre">decomp.py</span></code>) is what takes most of our time, a.k.a. the
bottleneck. We have to find a way to make this step go faster, or to avoid this
step (algorithmic optimization). Spending time on the rest of the code is
useless.</p>
<div class="admonition-profiling-outside-of-ipython-running-cprofile admonition">
<p class="admonition-title"><strong>Profiling outside of IPython, running ``cProfile``</strong></p>
<p>Similar profiling can be done outside of IPython, simply calling the
built-in <a class="reference external" href="https://docs.python.org/3/library/profile.html">Python profilers</a> <code class="docutils literal notranslate"><span class="pre">cProfile</span></code> and
<code class="docutils literal notranslate"><span class="pre">profile</span></code>.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$  </span>python<span class="w"> </span>-m<span class="w"> </span>cProfile<span class="w"> </span>-o<span class="w"> </span>demo.prof<span class="w"> </span>demo.py
</pre></div>
</div>
<p>Using the <code class="docutils literal notranslate"><span class="pre">-o</span></code> switch will output the profiler results to the file
<code class="docutils literal notranslate"><span class="pre">demo.prof</span></code> to view with an external tool. This can be useful if
you wish to process the profiler output with a visualization tool.</p>
</div>
</section>
<section id="line-profiler">
<h3>Line-profiler<a class="headerlink" href="#line-profiler" title="Link to this heading">#</a></h3>
<p>The profiler tells us which function takes most of the time, but not
where it is called.</p>
<p>For this, we use the
<a class="reference external" href="https://pypi.org/project/line-profiler/">line_profiler</a>: in the
source file, we decorate a few functions that we want to inspect with
<code class="docutils literal notranslate"><span class="pre">&#64;profile</span></code> (no need to import it)</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="nd">@profile</span>
<span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">():</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">pca</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">10</span><span class="p">]</span> <span class="o">@</span> <span class="n">data</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">fastica</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">whiten</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<p>Then we run the script using the <a class="reference external" href="https://pypi.org/project/line-profiler/">kernprof</a> command, with switches <code class="docutils literal notranslate"><span class="pre">-l,</span> <span class="pre">--line-by-line</span></code> and <code class="docutils literal notranslate"><span class="pre">-v,</span> <span class="pre">--view</span></code> to use the line-by-line profiler and view the results in addition to saving them:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>kernprof<span class="w"> </span>-l<span class="w"> </span>-v<span class="w"> </span>demo.py

<span class="go">Wrote profile results to demo.py.lprof</span>
<span class="go">Timer unit: 1e-06 s</span>

<span class="go">Total time: 1.27874 s</span>
<span class="go">File: demo.py</span>
<span class="go">Function: test at line 9</span>

<span class="go">Line #      Hits         Time  Per Hit   % Time  Line Contents</span>
<span class="go">==============================================================</span>
<span class="go">     9                                           @profile</span>
<span class="go">    10                                           def test():</span>
<span class="go">    11         1         69.0     69.0      0.0      rng = np.random.default_rng()</span>
<span class="go">    12         1       2453.0   2453.0      0.2      data = rng.random((5000, 100))</span>
<span class="go">    13         1    1274715.0 1274715.0     99.7      u, s, v = sp.linalg.svd(data)</span>
<span class="go">    14         1        413.0    413.0      0.0      pca = u[:, :10].T @ data</span>
<span class="go">    15         1       1094.0   1094.0      0.1      results = fastica(pca.T, whiten=False)</span>
</pre></div>
</div>
<p><strong>The SVD is taking all the time.</strong> We need to optimise this line.</p>
</section>
</section>
<section id="making-code-go-faster">
<h2>Making code go faster<a class="headerlink" href="#making-code-go-faster" title="Link to this heading">#</a></h2>
<p>Once we have identified the bottlenecks, we need to make the
corresponding code go faster.</p>
<section id="algorithmic-optimization">
<h3>Algorithmic optimization<a class="headerlink" href="#algorithmic-optimization" title="Link to this heading">#</a></h3>
<p>The first thing to look for is algorithmic optimization: are there ways
to compute less, or better?</p>
<p>For a high-level view of the problem, a good understanding of the maths
behind the algorithm helps. However, it is not uncommon to find simple
changes, like <strong>moving computation or memory allocation outside a for
loop</strong>, that bring in big gains.</p>
<section id="example-of-the-svd">
<h4>Example of the SVD<a class="headerlink" href="#example-of-the-svd" title="Link to this heading">#</a></h4>
<p>In both examples above, the SVD -
<a class="reference external" href="https://en.wikipedia.org/wiki/Singular_value_decomposition">Singular Value Decomposition</a>
- is what
takes most of the time. Indeed, the computational cost of this algorithm is
roughly <span class="math notranslate nohighlight">\(n^3\)</span> in the size of the input matrix.</p>
<p>However, in both of these example, we are not using all the output of
the SVD, but only the first few rows of its first return argument. If
we use the <code class="docutils literal notranslate"><span class="pre">svd</span></code> implementation of SciPy, we can ask for an incomplete
version of the SVD. Note that implementations of linear algebra in
SciPy are richer then those in NumPy and should be preferred.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="mi">1</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">14.5</span> <span class="n">s</span> <span class="n">per</span> <span class="n">loop</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="kn">import</span><span class="w"> </span><span class="nn">scipy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">sp</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="mi">1</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">14.2</span> <span class="n">s</span> <span class="n">per</span> <span class="n">loop</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">6</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="mi">1</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">295</span> <span class="n">ms</span> <span class="n">per</span> <span class="n">loop</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">7</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="mi">1</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">293</span> <span class="n">ms</span> <span class="n">per</span> <span class="n">loop</span>
</pre></div>
</div>
<p>We can then use this insight to <a class="reference download internal" download="" href="../../_downloads/9cf1b648269436444582bebf933adccf/demo_opt.py"><code class="xref download docutils literal notranslate"><span class="pre">optimize</span> <span class="pre">the</span> <span class="pre">previous</span> <span class="pre">code</span></code></a>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span><span class="w"> </span><span class="nf">test</span><span class="p">():</span>
    <span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
    <span class="n">u</span><span class="p">,</span> <span class="n">s</span><span class="p">,</span> <span class="n">v</span> <span class="o">=</span> <span class="n">sp</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">svd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">full_matrices</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">pca</span> <span class="o">=</span> <span class="n">u</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">10</span><span class="p">]</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">data</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">fastica</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">whiten</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="kn">import</span><span class="w"> </span><span class="nn">demo</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">demo</span><span class="o">.</span>
<span class="n">demo</span><span class="o">.</span><span class="n">fastica</span>   <span class="n">demo</span><span class="o">.</span><span class="n">np</span>        <span class="n">demo</span><span class="o">.</span><span class="n">prof</span><span class="o">.</span><span class="n">pdf</span>  <span class="n">demo</span><span class="o">.</span><span class="n">py</span>        <span class="n">demo</span><span class="o">.</span><span class="n">pyc</span>
<span class="n">demo</span><span class="o">.</span><span class="n">linalg</span>    <span class="n">demo</span><span class="o">.</span><span class="n">prof</span>      <span class="n">demo</span><span class="o">.</span><span class="n">prof</span><span class="o">.</span><span class="n">png</span>  <span class="n">demo</span><span class="o">.</span><span class="n">py</span><span class="o">.</span><span class="n">lprof</span>  <span class="n">demo</span><span class="o">.</span><span class="n">test</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">demo</span><span class="o">.</span><span class="n">test</span><span class="p">()</span>
<span class="n">ica</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">65</span><span class="p">:</span> <span class="ne">RuntimeWarning</span><span class="p">:</span> <span class="n">invalid</span> <span class="n">value</span> <span class="n">encountered</span> <span class="ow">in</span> <span class="n">sqrt</span>
  <span class="n">W</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">*</span> <span class="n">W</span>  <span class="c1"># W = (W * W.T) ^{-1/2} * W</span>
<span class="mi">1</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mf">17.5</span> <span class="n">s</span> <span class="n">per</span> <span class="n">loop</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="kn">import</span><span class="w"> </span><span class="nn">demo_opt</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="o">%</span><span class="n">timeit</span> <span class="n">demo_opt</span><span class="o">.</span><span class="n">test</span><span class="p">()</span>
<span class="mi">1</span> <span class="n">loops</span><span class="p">,</span> <span class="n">best</span> <span class="n">of</span> <span class="mi">3</span><span class="p">:</span> <span class="mi">208</span> <span class="n">ms</span> <span class="n">per</span> <span class="n">loop</span>
</pre></div>
</div>
<p>Real incomplete SVDs, e.g. computing only the first 10 eigenvectors, can
be computed with ARPACK, available in <code class="docutils literal notranslate"><span class="pre">scipy.sparse.linalg.eigsh</span></code>.</p>
<div class="admonition-computational-linear-algebra admonition">
<p class="admonition-title">Computational linear algebra</p>
<p>For certain algorithms, many of the bottlenecks will be linear
algebra computations. In this case, using the right function to solve
the right problem is key. For instance, an eigenvalue problem with a
symmetric matrix is easier to solve than with a general matrix. Also,
most often, you can avoid inverting a matrix and use a less costly
(and more numerically stable) operation.</p>
<p>Know your computational linear algebra. When in doubt, explore
<code class="docutils literal notranslate"><span class="pre">scipy.linalg</span></code>, and use <code class="docutils literal notranslate"><span class="pre">%timeit</span></code> to try out different alternatives
on your data.</p>
</div>
</section>
</section>
</section>
<section id="writing-faster-numerical-code">
<h2>Writing faster numerical code<a class="headerlink" href="#writing-faster-numerical-code" title="Link to this heading">#</a></h2>
<p>A complete discussion on advanced use of NumPy is found in chapter
<a class="reference internal" href="../advanced_numpy/index.html#advanced-numpy"><span class="std std-ref">Advanced NumPy</span></a>, or in the article <a class="reference external" href="https://hal.inria.fr/inria-00564007/en">The NumPy array: a structure for
efficient numerical computation</a>.
by van der Walt <em>et al.</em> Here we discuss only some commonly encountered tricks
to make code faster.</p>
<section id="vectorizing-for-loops">
<h3>Vectorizing for loops<a class="headerlink" href="#vectorizing-for-loops" title="Link to this heading">#</a></h3>
<p>Find tricks to avoid for loops using NumPy arrays. For this, masks and
indices arrays can be useful.</p>
</section>
<section id="broadcasting">
<h3>Broadcasting<a class="headerlink" href="#broadcasting" title="Link to this heading">#</a></h3>
<p>Use <a class="reference internal" href="../../intro/numpy/operations.html#broadcasting"><span class="std std-ref">broadcasting</span></a> to do operations on arrays as
small as possible before combining them.</p>
<!---
XXX: complement broadcasting in the NumPy chapter with the example of
the 3D grid
-->
</section>
<section id="in-place-operations">
<h3>In place operations<a class="headerlink" href="#in-place-operations" title="Link to this heading">#</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">10_000_000</span><span class="p">)</span>

<span class="o">%</span><span class="k">timeit</span> global a ; a = 0*a
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>28.7 ms ± 6.39 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> global a ; a *= 0
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>6.82 ms ± 463 μs per loop (mean ± std. dev. of 7 runs, 100 loops each)
</pre></div>
</div>
</div>
</div>
<p><strong>note</strong>: we need <code class="docutils literal notranslate"><span class="pre">global</span> <span class="pre">a</span></code> in the <code class="docutils literal notranslate"><span class="pre">timeit</span></code> so that it works as expected, as
otherwise it is assigning to <code class="docutils literal notranslate"><span class="pre">a</span></code>, and thus considers it as a local variable.</p>
</section>
<section id="be-easy-on-the-memory-use-views-and-not-copies">
<h3>Be easy on the memory: use views, and not copies<a class="headerlink" href="#be-easy-on-the-memory-use-views-and-not-copies" title="Link to this heading">#</a></h3>
<p>Copying big arrays is as costly as making simple numerical operations
on them:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">10_000_000</span><span class="p">)</span>

<span class="o">%</span><span class="k">timeit</span> a.copy()
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>18.6 ms ± 449 μs per loop (mean ± std. dev. of 7 runs, 100 loops each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> a + 1
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>18.9 ms ± 661 μs per loop (mean ± std. dev. of 7 runs, 100 loops each)
</pre></div>
</div>
</div>
</div>
</section>
<section id="beware-of-cache-effects">
<h3>Beware of cache effects<a class="headerlink" href="#beware-of-cache-effects" title="Link to this heading">#</a></h3>
<p>Memory access is cheaper when it is grouped: accessing a big array in a
continuous way is much faster than random access. This implies amongst
other things that <strong>smaller strides are faster</strong> (see
<a class="reference internal" href="../advanced_numpy/index.html#cache-effects"><span class="std std-ref">CPU cache effects</span></a>):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">5000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">),</span> <span class="n">order</span><span class="o">=</span><span class="s1">&#39;C&#39;</span><span class="p">)</span>

<span class="c1"># Row elements are far apart in memory, for C ordering.</span>
<span class="o">%</span><span class="k">timeit</span> np.median(c, axis=0)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>468 ms ± 29.6 ms per loop (mean ± std. dev. of 7 runs, 1 loop each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Column elements are contiguous in memory, for C ordering.</span>
<span class="o">%</span><span class="k">timeit</span> np.median(c, axis=1)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>132 ms ± 25 ms per loop (mean ± std. dev. of 7 runs, 10 loops each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="o">.</span><span class="n">strides</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(40000, 8)
</pre></div>
</div>
</div>
</div>
<p>This is the reason why Fortran ordering or C ordering may make a big
difference on speed of operations:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">rng</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">default_rng</span><span class="p">()</span>

<span class="n">a</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">20</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">18</span><span class="p">))</span>

<span class="n">b</span> <span class="o">=</span> <span class="n">rng</span><span class="o">.</span><span class="n">random</span><span class="p">((</span><span class="mi">20</span><span class="p">,</span> <span class="mi">2</span><span class="o">**</span><span class="mi">18</span><span class="p">))</span>

<span class="o">%</span><span class="k">timeit</span> b @ a.T
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12.9 ms ± 1.45 ms per loop (mean ± std. dev. of 7 runs, 100 loops each)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ascontiguousarray</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

<span class="o">%</span><span class="k">timeit</span> b @ c
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12.1 ms ± 179 μs per loop (mean ± std. dev. of 7 runs, 100 loops each)
</pre></div>
</div>
</div>
</div>
<p>Note that copying the data to work around this effect may not be worth it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">timeit</span> c = np.ascontiguousarray(a.T)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12.6 ms ± 524 μs per loop (mean ± std. dev. of 7 runs, 100 loops each)
</pre></div>
</div>
</div>
</div>
<p>Using <a class="reference external" href="https://github.com/pydata/numexpr">numexpr</a> can be useful to
automatically optimize code for such effects.</p>
</section>
<section id="use-compiled-code">
<h3>Use compiled code<a class="headerlink" href="#use-compiled-code" title="Link to this heading">#</a></h3>
<p>The last resort, once you are sure that all the high-level optimizations have
been explored, is to transfer the hot spots, i.e. the few lines or functions
in which most of the time is spent, to compiled code. For compiled code, the
preferred option is to use <a class="reference external" href="https://www.cython.org">Cython</a>: it is easy to
transform exiting Python code in compiled code, and with a good use of the
<a class="reference external" href="https://docs.cython.org/en/latest/src/tutorial/numpy.html">NumPy support</a>
yields efficient code on NumPy arrays, for instance by unrolling loops.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>For all the above: profile and time your choices. Don’t base your
optimization on theoretical considerations.</p>
</div>
</section>
</section>
<section id="additional-links">
<h2>Additional Links<a class="headerlink" href="#additional-links" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p>If you need to profile memory usage, you could try the
<a class="reference external" href="https://pypi.org/project/memory-profiler">memory_profiler</a></p></li>
<li><p>If you need to profile down into C extensions, you could try using
<a class="reference external" href="https://github.com/gperftools/gperftools">gperftools</a> from Python with
<a class="reference external" href="https://pypi.org/project/yep">yep</a>.</p></li>
<li><p>If you would like to track performance of your code across time, i.e. as you
make new commits to your repository, you could try:
<a class="reference external" href="https://asv.readthedocs.io/en/stable/">asv</a></p></li>
<li><p>If you need some interactive visualization why not try
<a class="reference external" href="https://www.vrplumber.com/programming/runsnakerun/">RunSnakeRun</a></p></li>
</ul>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./advanced/optimizing"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../debugging/index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Debugging code</p>
      </div>
    </a>
    <a class="right-next"
       href="../scipy_sparse/introduction.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Introduction</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#optimization-workflow">Optimization workflow</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#profiling-python-code">Profiling Python code</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#timeit">Timeit</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#profiler">Profiler</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#line-profiler">Line-profiler</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#making-code-go-faster">Making code go faster</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#algorithmic-optimization">Algorithmic optimization</a><ul class="nav section-nav flex-column">
<li class="toc-h4 nav-item toc-entry"><a class="reference internal nav-link" href="#example-of-the-svd">Example of the SVD</a></li>
</ul>
</li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#writing-faster-numerical-code">Writing faster numerical code</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#vectorizing-for-loops">Vectorizing for loops</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#broadcasting">Broadcasting</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#in-place-operations">In place operations</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#be-easy-on-the-memory-use-views-and-not-copies">Be easy on the memory: use views, and not copies</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#beware-of-cache-effects">Beware of cache effects</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#use-compiled-code">Use compiled code</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#additional-links">Additional Links</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Scientific Python developers
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>