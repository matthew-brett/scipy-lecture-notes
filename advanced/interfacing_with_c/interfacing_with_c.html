
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Interfacing with C &#8212; Scientific Python Lectures</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.2/css/all.min.css?digest=dfe6caa3a7d634c4db9b" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../_static/styles/sphinx-book-theme.css?v=eba8b062" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.8ecb98da25f57f5357bf6f572d296f466b2cfe2517ffebfabe82451661e28f02.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="../../_static/exercise.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b" />
  <script src="../../_static/vendor/fontawesome/6.5.2/js/all.min.js?digest=dfe6caa3a7d634c4db9b"></script>

    <script src="../../_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../../_static/copybutton.js?v=f281be69"></script>
    <script src="../../_static/scripts/sphinx-book-theme.js?v=887ef09a"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../../_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="../../_static/design-tabs.js?v=f930bc37"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="../../_static/sphinx-thebe.js?v=c100c467"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'advanced/interfacing_with_c/interfacing_with_c';</script>
    <link rel="canonical" href="https://matthew-brett.github.io/scipy-lecture-notes/advanced/interfacing_with_c/interfacing_with_c.html" />
    <link rel="icon" href="../../_static/sp_lectures.png"/>
    <link rel="author" title="About these documents" href="../../about.html" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Packages and applications" href="../../packages/index.html" />
    <link rel="prev" title="Mathematical optimization: finding minima of functions" href="../mathematical_optimization/index.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-primary-sidebar-checkbox"/>
  <label class="overlay overlay-primary" for="pst-primary-sidebar-checkbox"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          id="pst-secondary-sidebar-checkbox"/>
  <label class="overlay overlay-secondary" for="pst-secondary-sidebar-checkbox"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  
    
  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
    
    
      
    
    
    <img src="../../_static/sp_lectures.png" class="logo__image only-light" alt="Scientific Python Lectures - Home"/>
    <script>document.write(`<img src="../../_static/sp_lectures.png" class="logo__image only-dark" alt="Scientific Python Lectures - Home"/>`);</script>
  
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <p aria-level="2" class="caption" role="heading"><span class="caption-text">Getting started with Python for Science</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../intro/index.html">Getting started with Python for science</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/intro.html">Python scientific computing ecosystem</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../intro/language/python_language.html">The Python language</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/first_steps.html">First steps</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/basic_types.html">Basic types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/control_flow.html">Control Flow</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/functions.html">Defining functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/reusing_code.html">Reusing code: scripts and modules</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/io.html">Input and Output</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/standard_library.html">Standard Library</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/exceptions.html">Exception handling in Python</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/language/oop.html">Object-oriented programming (OOP)</a></li>
</ul>
</details></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../../intro/numpy/index.html">NumPy: creating and manipulating numerical data</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../../intro/numpy/array_object.html">The NumPy array object</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/numpy/operations.html">Numerical operations on arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/numpy/elaborate_arrays.html">More elaborate arrays</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/numpy/advanced_operations.html">Advanced operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../intro/numpy/exercises.html">Some exercises</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/matplotlib/index.html">Matplotlib: plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/scipy/index.html">SciPy : high-level scientific computing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../intro/help/help.html">Getting help and finding documentation</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Advanced topics</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../index.html">Advanced topics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_python/index.html">Advanced Python Constructs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../advanced_numpy/index.html">Advanced NumPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debugging/index.html">Debugging code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../optimizing/index.html">Optimizing code</a></li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../scipy_sparse/introduction.html">Introduction</a><details><summary><span class="toctree-toggle" role="presentation"><i class="fa-solid fa-chevron-down"></i></span></summary><ul>
<li class="toctree-l2"><a class="reference internal" href="../scipy_sparse/storage_schemes.html">Storage Schemes</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scipy_sparse/solvers.html">Linear System Solvers</a></li>
<li class="toctree-l2"><a class="reference internal" href="../scipy_sparse/other_packages.html">Other Interesting Packages</a></li>
</ul>
</details></li>
<li class="toctree-l1"><a class="reference internal" href="../image_processing/index.html">Image manipulation and processing using NumPy and SciPy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../mathematical_optimization/index.html">Mathematical optimization: finding minima of functions</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Interfacing with C</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">Packages and applications</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../packages/index.html">Packages and applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages/statistics/index.html">Statistics in Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages/sympy.html">Sympy : Symbolic Mathematics in Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages/scikit-image/index.html"><code class="docutils literal notranslate"><span class="pre">scikit-image</span></code>: image processing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../packages/scikit-learn/index.html">scikit-learn: machine learning in Python</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">About the Scientific Python Lectures</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../about.html">About the Scientific Python Lecture notes</a></li>




</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><button class="sidebar-toggle primary-toggle btn btn-sm" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</button></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-source-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Source repositories">
    <i class="fab fa-github"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="https://github.com/matthew-brett/scipy-lecture-notes" target="_blank"
   class="btn btn-sm btn-source-repository-button dropdown-item"
   title="Source repository"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>
<span class="btn__text-container">Repository</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/matthew-brett/scipy-lecture-notes/edit/main/advanced/interfacing_with_c/interfacing_with_c.Rmd" target="_blank"
   class="btn btn-sm btn-source-edit-button dropdown-item"
   title="Suggest edit"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-pencil-alt"></i>
  </span>
<span class="btn__text-container">Suggest edit</span>
</a>
</li>
      
      
      
      
      <li><a href="https://github.com/matthew-brett/scipy-lecture-notes/issues/new?title=Issue%20on%20page%20%2Fadvanced/interfacing_with_c/interfacing_with_c.html&body=Your%20issue%20content%20here." target="_blank"
   class="btn btn-sm btn-source-issues-button dropdown-item"
   title="Open an issue"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>
<span class="btn__text-container">Open issue</span>
</a>
</li>
      
  </ul>
</div>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../../_sources/advanced/interfacing_with_c/interfacing_with_c.Rmd" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.Rmd</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="theme-switch fa-solid fa-sun fa-lg" data-mode="light"></i>
    <i class="theme-switch fa-solid fa-moon fa-lg" data-mode="dark"></i>
    <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"></i>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm pst-navbar-icon search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<button class="sidebar-toggle secondary-toggle btn btn-sm" title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</button>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Interfacing with C</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#python-c-api">Python-C-Api</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example">Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#numpy-support">NumPy Support</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ctypes">Ctypes</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">NumPy Support</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#swig">SWIG</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">NumPy Support</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cython">Cython</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">NumPy Support</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#further-reading-and-references">Further Reading and References</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Python-C-API</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">Ctypes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">SWIG</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">Cython</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="interfacing-with-c">
<h1>Interfacing with C<a class="headerlink" href="#interfacing-with-c" title="Link to this heading">#</a></h1>
<p><strong>Author</strong>: <em>Valentin Haenel</em></p>
<!---
TODO:

* Download links
* Timing?
* Additional documentation
* What about overflow?
-->
<p>This chapter contains an <em>introduction</em> to the many different routes for
making your native code (primarily <code class="docutils literal notranslate"><span class="pre">C/C++</span></code>) available from Python, a
process commonly referred to <em>wrapping</em>. The goal of this chapter is to
give you a flavour of what technologies exist and what their respective
merits and shortcomings are, so that you can select the appropriate one
for your specific needs. In any case, once you do start wrapping, you
almost certainly will want to consult the respective documentation for
your selected technique.</p>
<section id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Link to this heading">#</a></h2>
<p>This chapter covers the following techniques:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.python.org/3/c-api/">Python-C-Api</a></p></li>
<li><p><a class="reference external" href="https://docs.python.org/3/library/ctypes.html">Ctypes</a></p></li>
<li><p><a class="reference external" href="https://www.swig.org/">SWIG (Simplified Wrapper and Interface Generator)</a></p></li>
<li><p><a class="reference external" href="https://cython.org/">Cython</a></p></li>
</ul>
<p>These four techniques are perhaps the most well known ones, of which Cython is
probably the most advanced one and the one you should consider using first. The
others are also important, if you want to understand the wrapping problem from
different angles. Having said that, there are other alternatives out there,
but having understood the basics of the ones above, you will be in a position
to evaluate the technique of your choice to see if it fits your needs.</p>
<p>The following criteria may be useful when evaluating a technology:</p>
<ul class="simple">
<li><p>Are additional libraries required?</p></li>
<li><p>Is the code autogenerated?</p></li>
<li><p>Does it need to be compiled?</p></li>
<li><p>Is there good support for interacting with NumPy arrays?</p></li>
<li><p>Does it support C++?</p></li>
</ul>
<p>Before you set out, you should consider your use case. When interfacing with
native code, there are usually two use-cases that come up:</p>
<ul class="simple">
<li><p>Existing code in C/C++ that needs to be leveraged, either because it already
exists, or because it is faster.</p></li>
<li><p>Python code too slow, push inner loops to native code</p></li>
</ul>
<p>Each technology is demonstrated by wrapping the <code class="docutils literal notranslate"><span class="pre">cos</span></code> function from
<code class="docutils literal notranslate"><span class="pre">math.h</span></code>. While this is a mostly a trivial example, it should serve us well
to demonstrate the basics of the wrapping solution. Since each technique also
includes some form of NumPy support, this is also demonstrated using an
example where the cosine is computed on some kind of array.</p>
<p>Last but not least, two small warnings:</p>
<ul class="simple">
<li><p>All of these techniques may crash (segmentation fault) the Python
interpreter, which is (usually) due to bugs in the C code.</p></li>
<li><p>All the examples have been done on Linux, they <em>should</em> be possible on other
operating systems.</p></li>
<li><p>You will need a C compiler for most of the examples.</p></li>
</ul>
</section>
<section id="python-c-api">
<h2>Python-C-Api<a class="headerlink" href="#python-c-api" title="Link to this heading">#</a></h2>
<p>The <a class="reference external" href="https://docs.python.org/3/c-api/">Python-C-API</a> is the backbone of the
standard Python interpreter (a.k.a <em>CPython</em>). Using this API it is possible to
write Python extension module in C and C++. Obviously, these extension modules
can, by virtue of language compatibility, call any function written in C or
C++.</p>
<p>When using the Python-C-API, one usually writes much boilerplate code, first to
parse the arguments that were given to a function, and later to construct the
return type.</p>
<p><strong>Advantages</strong></p>
<ul class="simple">
<li><p>Requires no additional libraries</p></li>
<li><p>Lots of low-level control</p></li>
<li><p>Entirely usable from C++</p></li>
</ul>
<p><strong>Disadvantages</strong></p>
<ul class="simple">
<li><p>May require a substantial amount of effort</p></li>
<li><p>Much overhead in the code</p></li>
<li><p>Must be compiled</p></li>
<li><p>High maintenance cost</p></li>
<li><p>No forward compatibility across Python versions as C-API changes</p></li>
<li><p>Reference count bugs are easy to create and very hard to track down.</p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The Python-C-Api example here serves mainly for didactic reasons. Many of
the other techniques actually depend on this, so it is good to have a
high-level understanding of how it works. In 99% of the use-cases you will
be better off, using an alternative technique.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Since reference counting bugs are easy to create and hard to track down,
anyone really needing to use the Python C-API should read the <a class="reference external" href="https://docs.python.org/3/c-api/intro.html#objects-types-and-reference-counts">section
about objects, types and reference counts</a>
from the official python documentation. Additionally, there is a tool by the
name of <a class="reference external" href="https://gcc-python-plugin.readthedocs.io/en/latest/cpychecker.html">cpychecker</a>
which can help discover common errors with reference counting.</p>
</div>
<section id="example">
<h3>Example<a class="headerlink" href="#example" title="Link to this heading">#</a></h3>
<p>The following C-extension module, make the <code class="docutils literal notranslate"><span class="pre">cos</span></code> function from the standard
math library available to Python:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*  Example of wrapping cos function from math.h with the Python-C-API. */</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Python.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span>

<span class="cm">/*  wrapped cosine function */</span>
<span class="k">static</span><span class="w"> </span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="nf">cos_func</span><span class="p">(</span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">value</span><span class="p">;</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">answer</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/*  parse the input, from python float to c double */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;d&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">value</span><span class="p">))</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/* if the above function returns -1, an appropriate Python exception will</span>
<span class="cm">     * have been set, and the function simply returns NULL</span>
<span class="cm">     */</span>

<span class="w">    </span><span class="cm">/* call cos from libm */</span>
<span class="w">    </span><span class="n">answer</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/*  construct the output from cos, from c double to python float */</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">Py_BuildValue</span><span class="p">(</span><span class="s">&quot;f&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">answer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*  define functions in module */</span>
<span class="k">static</span><span class="w"> </span><span class="n">PyMethodDef</span><span class="w"> </span><span class="n">CosMethods</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span>
<span class="p">{</span>
<span class="w">     </span><span class="p">{</span><span class="s">&quot;cos_func&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cos_func</span><span class="p">,</span><span class="w"> </span><span class="n">METH_VARARGS</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;evaluate the cosine&quot;</span><span class="p">},</span>
<span class="w">     </span><span class="p">{</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>

<span class="cp">#if PY_MAJOR_VERSION &gt;= 3</span>
<span class="cm">/* module initialization */</span>
<span class="cm">/* Python version 3*/</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">PyModuleDef</span><span class="w"> </span><span class="n">cModPyDem</span><span class="w"> </span><span class="o">=</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;cos_module&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Some documentation&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="mi">-1</span><span class="p">,</span>
<span class="w">    </span><span class="n">CosMethods</span>
<span class="p">};</span>

<span class="n">PyMODINIT_FUNC</span>
<span class="nf">PyInit_cos_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cModPyDem</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cm">/* module initialization */</span>
<span class="cm">/* Python version 2 */</span>
<span class="n">PyMODINIT_FUNC</span>
<span class="nf">initcos_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="n">Py_InitModule</span><span class="p">(</span><span class="s">&quot;cos_module&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">CosMethods</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p>As you can see, there is much boilerplate, both to «massage» the arguments and
return types into place and for the module initialisation. Although some of
this is amortised, as the extension grows, the boilerplate required for each
function(s) remains.</p>
<p>The standard python build system, <code class="docutils literal notranslate"><span class="pre">setuptools</span></code>, supports compiling
C-extensions via a <code class="docutils literal notranslate"><span class="pre">setup.py</span></code> file:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">setuptools</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">Extension</span>


<span class="c1"># define the extension module</span>
<span class="n">cos_module</span> <span class="o">=</span> <span class="n">Extension</span><span class="p">(</span><span class="s2">&quot;cos_module&quot;</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cos_module.c&quot;</span><span class="p">])</span>

<span class="c1"># run the setup</span>
<span class="n">setup</span><span class="p">(</span><span class="n">ext_modules</span><span class="o">=</span><span class="p">[</span><span class="n">cos_module</span><span class="p">])</span>
</pre></div>
</div>
<p>The setup file is called as follows:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>advanced/interfacing_with_c/python_c_api

<span class="gp">$ </span>ls
<span class="go">cos_module.c  setup.py</span>

<span class="gp">$ </span>python<span class="w"> </span>setup.py<span class="w"> </span>build_ext<span class="w"> </span>--inplace
<span class="go">running build_ext</span>
<span class="go">building &#39;cos_module&#39; extension</span>
<span class="go">creating build</span>
<span class="go">creating build/temp.linux-x86_64-2.7</span>
<span class="go">gcc -pthread -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -fPIC -I/home/esc/anaconda/include/python2.7 -c cos_module.c -o build/temp.linux-x86_64-2.7/cos_module.o</span>
<span class="go">gcc -pthread -shared build/temp.linux-x86_64-2.7/cos_module.o -L/home/esc/anaconda/lib -lpython2.7 -o /home/esc/git-working/scientific-python-lectures/advanced/interfacing_with_c/python_c_api/cos_module.so</span>

<span class="gp">$ </span>ls
<span class="go">build/  cos_module.c  cos_module.so  setup.py</span>
</pre></div>
</div>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">build_ext</span></code> is to build extension modules</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">--inplace</span></code> will output the compiled extension module into the current directory</p></li>
</ul>
<p>The file <code class="docutils literal notranslate"><span class="pre">cos_module.so</span></code> contains the compiled extension, which we can now load in the IPython interpreter:</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In Python 3, the filename for compiled modules includes metadata on the Python
interpreter (see <a class="reference external" href="https://peps.python.org/pep-3149/">PEP 3149</a>) and is thus
longer. The import statement is not affected by this.</p>
</div>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [1]: </span><span class="kn">import</span><span class="w"> </span><span class="nn">cos_module</span>

<span class="gp">In [2]: </span>cos_module<span class="o">?</span>
<span class="go">Type:       module</span>
<span class="go">String Form:&lt;module &#39;cos_module&#39; from &#39;cos_module.so&#39;&gt;</span>
<span class="go">File:       /home/esc/git-working/scientific-python-lectures/advanced/interfacing_with_c/python_c_api/cos_module.so</span>
<span class="go">Docstring:  &lt;no docstring&gt;</span>

<span class="gp">In [3]: </span><span class="nb">dir</span><span class="p">(</span><span class="n">cos_module</span><span class="p">)</span>
<span class="gh">Out[3]: </span><span class="go">[&#39;__doc__&#39;, &#39;__file__&#39;, &#39;__name__&#39;, &#39;__package__&#39;, &#39;cos_func&#39;]</span>

<span class="gp">In [4]: </span><span class="n">cos_module</span><span class="o">.</span><span class="n">cos_func</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<span class="gh">Out[4]: </span><span class="go">0.5403023058681398</span>

<span class="gp">In [5]: </span><span class="n">cos_module</span><span class="o">.</span><span class="n">cos_func</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<span class="gh">Out[5]: </span><span class="go">1.0</span>

<span class="gp">In [6]: </span><span class="n">cos_module</span><span class="o">.</span><span class="n">cos_func</span><span class="p">(</span><span class="mf">3.14159265359</span><span class="p">)</span>
<span class="gh">Out[7]: </span><span class="go">-1.0</span>
</pre></div>
</div>
<p>Now let’s see how robust this is:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [10]: </span><span class="n">cos_module</span><span class="o">.</span><span class="n">cos_func</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">&lt;ipython-input-10-11bee483665d&gt;</span> in <span class="ni">&lt;module&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">cos_module</span><span class="o">.</span><span class="n">cos_func</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="ne">TypeError</span>: a float is required
</pre></div>
</div>
</section>
<section id="numpy-support">
<h3>NumPy Support<a class="headerlink" href="#numpy-support" title="Link to this heading">#</a></h3>
<p>Analog to the Python-C-API, NumPy, which is itself implemented as a
C-extension, comes with the <a class="reference external" href="https://numpy.org/doc/stable/reference/c-api">NumPy-C-API</a>. This API can be used
to create and manipulate NumPy arrays from C, when writing a custom
C-extension. See also: <a class="reference internal" href="../advanced_numpy/index.html#advanced-numpy"><span class="std std-ref">Advanced NumPy</span></a>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you do ever need to use the NumPy C-API refer to the documentation about
<a class="reference external" href="https://numpy.org/doc/stable/reference/c-api/array.html">Arrays</a> and
<a class="reference external" href="https://numpy.org/doc/stable/reference/c-api/iterator.html">Iterators</a>.</p>
</div>
<p>The following example shows how to pass NumPy arrays as arguments to functions
and how to iterate over NumPy arrays using the (old) NumPy-C-API. It simply
takes an array as argument applies the cosine function from the <code class="docutils literal notranslate"><span class="pre">math.h</span></code> and
returns a resulting new array.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*  Example of wrapping the cos function from math.h using the NumPy-C-API. */</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Python.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;numpy/arrayobject.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span>


<span class="cm">/*  wrapped cosine function */</span>
<span class="k">static</span><span class="w"> </span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="nf">cos_func_np</span><span class="p">(</span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="n">PyObject</span><span class="o">*</span><span class="w"> </span><span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">PyArrayObject</span><span class="w"> </span><span class="o">*</span><span class="n">arrays</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span><span class="w">  </span><span class="cm">/* holds input and output array */</span>
<span class="w">    </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">ret</span><span class="p">;</span>
<span class="w">    </span><span class="n">NpyIter</span><span class="w"> </span><span class="o">*</span><span class="n">iter</span><span class="p">;</span>
<span class="w">    </span><span class="n">npy_uint32</span><span class="w"> </span><span class="n">op_flags</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="w">    </span><span class="n">npy_uint32</span><span class="w"> </span><span class="n">iterator_flags</span><span class="p">;</span>
<span class="w">    </span><span class="n">PyArray_Descr</span><span class="w"> </span><span class="o">*</span><span class="n">op_dtypes</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="w">    </span><span class="n">NpyIter_IterNextFunc</span><span class="w"> </span><span class="o">*</span><span class="n">iternext</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/*  parse single NumPy array argument */</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">!</span><span class="n">PyArg_ParseTuple</span><span class="p">(</span><span class="n">args</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;O!&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">PyArray_Type</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">arrays</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">arrays</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span><span class="w">  </span><span class="cm">/* The result will be allocated by the iterator */</span>

<span class="w">    </span><span class="cm">/* Set up and create the iterator */</span>
<span class="w">    </span><span class="n">iterator_flags</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">NPY_ITER_ZEROSIZE_OK</span><span class="w"> </span><span class="o">|</span>
<span class="w">                      </span><span class="cm">/*</span>
<span class="cm">                       * Enable buffering in case the input is not behaved</span>
<span class="cm">                       * (native byte order or not aligned),</span>
<span class="cm">                       * disabling may speed up some cases when it is known to</span>
<span class="cm">                       * be unnecessary.</span>
<span class="cm">                       */</span>
<span class="w">                      </span><span class="n">NPY_ITER_BUFFERED</span><span class="w"> </span><span class="o">|</span>
<span class="w">                      </span><span class="cm">/* Manually handle innermost iteration for speed: */</span>
<span class="w">                      </span><span class="n">NPY_ITER_EXTERNAL_LOOP</span><span class="w"> </span><span class="o">|</span>
<span class="w">                      </span><span class="n">NPY_ITER_GROWINNER</span><span class="p">);</span>

<span class="w">    </span><span class="n">op_flags</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">NPY_ITER_READONLY</span><span class="w"> </span><span class="o">|</span>
<span class="w">                   </span><span class="cm">/*</span>
<span class="cm">                    * Required that the arrays are well behaved, since the cos</span>
<span class="cm">                    * call below requires this.</span>
<span class="cm">                    */</span>
<span class="w">                   </span><span class="n">NPY_ITER_NBO</span><span class="w"> </span><span class="o">|</span>
<span class="w">                   </span><span class="n">NPY_ITER_ALIGNED</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* Ask the iterator to allocate an array to write the output to */</span>
<span class="w">    </span><span class="n">op_flags</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NPY_ITER_WRITEONLY</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">NPY_ITER_ALLOCATE</span><span class="p">;</span>

<span class="w">    </span><span class="cm">/*</span>
<span class="cm">     * Ensure the iteration has the correct type, could be checked</span>
<span class="cm">     * specifically here.</span>
<span class="cm">     */</span>
<span class="w">    </span><span class="n">op_dtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyArray_DescrFromType</span><span class="p">(</span><span class="n">NPY_DOUBLE</span><span class="p">);</span>
<span class="w">    </span><span class="n">op_dtypes</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">op_dtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

<span class="w">    </span><span class="cm">/* Create the NumPy iterator object: */</span>
<span class="w">    </span><span class="n">iter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NpyIter_MultiNew</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">arrays</span><span class="p">,</span><span class="w"> </span><span class="n">iterator_flags</span><span class="p">,</span>
<span class="w">                            </span><span class="cm">/* Use input order for output and iteration */</span>
<span class="w">                            </span><span class="n">NPY_KEEPORDER</span><span class="p">,</span>
<span class="w">                            </span><span class="cm">/* Allow only byte-swapping of input */</span>
<span class="w">                            </span><span class="n">NPY_EQUIV_CASTING</span><span class="p">,</span><span class="w"> </span><span class="n">op_flags</span><span class="p">,</span><span class="w"> </span><span class="n">op_dtypes</span><span class="p">);</span>
<span class="w">    </span><span class="n">Py_DECREF</span><span class="p">(</span><span class="n">op_dtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w">  </span><span class="cm">/* The second one is identical. */</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iter</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>

<span class="w">    </span><span class="n">iternext</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NpyIter_GetIterNext</span><span class="p">(</span><span class="n">iter</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">iternext</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">NpyIter_Deallocate</span><span class="p">(</span><span class="n">iter</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* Fetch the output array which was allocated by the iterator: */</span>
<span class="w">    </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">NpyIter_GetOperandArray</span><span class="p">(</span><span class="n">iter</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="n">Py_INCREF</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">NpyIter_GetIterSize</span><span class="p">(</span><span class="n">iter</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * If there are no elements, the loop cannot be iterated.</span>
<span class="cm">         * This check is necessary with NPY_ITER_ZEROSIZE_OK.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="n">NpyIter_Deallocate</span><span class="p">(</span><span class="n">iter</span><span class="p">);</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cm">/* The location of the data pointer which the iterator may update */</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">**</span><span class="n">dataptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NpyIter_GetDataPtrArray</span><span class="p">(</span><span class="n">iter</span><span class="p">);</span>
<span class="w">    </span><span class="cm">/* The location of the stride which the iterator may update */</span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="o">*</span><span class="n">strideptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NpyIter_GetInnerStrideArray</span><span class="p">(</span><span class="n">iter</span><span class="p">);</span>
<span class="w">    </span><span class="cm">/* The location of the inner loop size which the iterator may update */</span>
<span class="w">    </span><span class="n">npy_intp</span><span class="w"> </span><span class="o">*</span><span class="n">innersizeptr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NpyIter_GetInnerLoopSizePtr</span><span class="p">(</span><span class="n">iter</span><span class="p">);</span>

<span class="w">    </span><span class="cm">/* iterate over the arrays */</span>
<span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">stride</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strideptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">        </span><span class="n">npy_intp</span><span class="w"> </span><span class="n">count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">innersizeptr</span><span class="p">;</span>
<span class="w">        </span><span class="cm">/* out is always contiguous, so use double */</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">dataptr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
<span class="w">        </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">in</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dataptr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

<span class="w">        </span><span class="cm">/* The output is allocated and guaranteed contiguous (out++ works): */</span>
<span class="w">        </span><span class="n">assert</span><span class="p">(</span><span class="n">strideptr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="kt">double</span><span class="p">));</span>

<span class="w">        </span><span class="cm">/*</span>
<span class="cm">         * For optimization it can make sense to add a check for</span>
<span class="cm">         * stride == sizeof(double) to allow the compiler to optimize for that.</span>
<span class="cm">         */</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">count</span><span class="o">--</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="o">*</span><span class="n">out</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">in</span><span class="p">);</span>
<span class="w">            </span><span class="n">out</span><span class="o">++</span><span class="p">;</span>
<span class="w">            </span><span class="n">in</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">stride</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">iternext</span><span class="p">(</span><span class="n">iter</span><span class="p">));</span>

<span class="w">    </span><span class="cm">/* Clean up and return the result */</span>
<span class="w">    </span><span class="n">NpyIter_Deallocate</span><span class="p">(</span><span class="n">iter</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*  define functions in module */</span>
<span class="k">static</span><span class="w"> </span><span class="n">PyMethodDef</span><span class="w"> </span><span class="n">CosMethods</span><span class="p">[]</span><span class="w"> </span><span class="o">=</span>
<span class="p">{</span>
<span class="w">     </span><span class="p">{</span><span class="s">&quot;cos_func_np&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cos_func_np</span><span class="p">,</span><span class="w"> </span><span class="n">METH_VARARGS</span><span class="p">,</span>
<span class="w">         </span><span class="s">&quot;evaluate the cosine on a NumPy array&quot;</span><span class="p">},</span>
<span class="w">     </span><span class="p">{</span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">}</span>
<span class="p">};</span>


<span class="cp">#if PY_MAJOR_VERSION &gt;= 3</span>
<span class="cm">/* module initialization */</span>
<span class="cm">/* Python version 3*/</span>
<span class="k">static</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">PyModuleDef</span><span class="w"> </span><span class="n">cModPyDem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">PyModuleDef_HEAD_INIT</span><span class="p">,</span>
<span class="w">    </span><span class="s">&quot;cos_module&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Some documentation&quot;</span><span class="p">,</span>
<span class="w">    </span><span class="mi">-1</span><span class="p">,</span>
<span class="w">    </span><span class="n">CosMethods</span>
<span class="p">};</span>
<span class="n">PyMODINIT_FUNC</span><span class="w"> </span><span class="nf">PyInit_cos_module_np</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">module</span><span class="p">;</span>
<span class="w">    </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PyModule_Create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cModPyDem</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">module</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/* IMPORTANT: this must be called */</span>
<span class="w">    </span><span class="n">import_array</span><span class="p">();</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">PyErr_Occurred</span><span class="p">())</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">module</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="cm">/* module initialization */</span>
<span class="cm">/* Python version 2 */</span>
<span class="n">PyMODINIT_FUNC</span><span class="w"> </span><span class="nf">initcos_module_np</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">PyObject</span><span class="w"> </span><span class="o">*</span><span class="n">module</span><span class="p">;</span>
<span class="w">    </span><span class="n">module</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Py_InitModule</span><span class="p">(</span><span class="s">&quot;cos_module_np&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">CosMethods</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="p">(</span><span class="n">module</span><span class="o">==</span><span class="nb">NULL</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
<span class="w">    </span><span class="cm">/* IMPORTANT: this must be called */</span>
<span class="w">    </span><span class="n">import_array</span><span class="p">();</span>
<span class="w">    </span><span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>
</pre></div>
</div>
<p>To compile this we can use <code class="docutils literal notranslate"><span class="pre">setuptools</span></code> again. However we need to be sure to
include the NumPy headers by using <a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.get_include.html#numpy.get_include" title="(in NumPy v2.3)"><code class="xref py py-func docutils literal notranslate"><span class="pre">numpy.get_include()</span></code></a>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">setuptools</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">Extension</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>


<span class="c1"># define the extension module</span>
<span class="n">cos_module_np</span> <span class="o">=</span> <span class="n">Extension</span><span class="p">(</span>
    <span class="s2">&quot;cos_module_np&quot;</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cos_module_np.c&quot;</span><span class="p">],</span> <span class="n">include_dirs</span><span class="o">=</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">get_include</span><span class="p">()]</span>
<span class="p">)</span>

<span class="c1"># run the setup</span>
<span class="n">setup</span><span class="p">(</span><span class="n">ext_modules</span><span class="o">=</span><span class="p">[</span><span class="n">cos_module_np</span><span class="p">])</span>
</pre></div>
</div>
<p>To convince ourselves if this does actually works, we run the following test
script:</p>
<div class="highlight-numpy notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">cos_module_np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">cos_module_np</span><span class="o">.</span><span class="n">cos_func_np</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>


<span class="c1"># Below are more specific tests for less common usage</span>
<span class="c1"># ---------------------------------------------------</span>

<span class="c1"># The function is OK with `x` not having any elements:</span>
<span class="n">x_empty</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">array</span><span class="p">([],</span> <span class="kp">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">y_empty</span> <span class="o">=</span> <span class="n">cos_module_np</span><span class="o">.</span><span class="n">cos_func_np</span><span class="p">(</span><span class="n">x_empty</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="kp">array_equal</span><span class="p">(</span><span class="n">y_empty</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="kp">array</span><span class="p">([],</span> <span class="kp">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">))</span>

<span class="c1"># The function can handle arbitrary dimensions and non-contiguous data.</span>
<span class="c1"># `x_2d` contains the same values, but has a different shape.</span>
<span class="c1"># Note: `x_2d.flags` shows it is not contiguous and `x2.ravel() == x`</span>
<span class="n">x_2d</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="kp">repeat</span><span class="p">(</span><span class="mi">2</span><span class="p">)[::</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="kp">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">y_2d</span> <span class="o">=</span> <span class="n">cos_module_np</span><span class="o">.</span><span class="n">cos_func_np</span><span class="p">(</span><span class="n">x_2d</span><span class="p">)</span>
<span class="c1"># When reshaped back, the same result is given:</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="kp">array_equal</span><span class="p">(</span><span class="n">y_2d</span><span class="o">.</span><span class="kp">ravel</span><span class="p">(),</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># The function handles incorrect byte-order fine:</span>
<span class="n">x_not_native_byteorder</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="kp">astype</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="kp">dtype</span><span class="o">.</span><span class="kp">newbyteorder</span><span class="p">())</span>
<span class="n">y_not_native_byteorder</span> <span class="o">=</span> <span class="n">cos_module_np</span><span class="o">.</span><span class="n">cos_func_np</span><span class="p">(</span><span class="n">x_not_native_byteorder</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">np</span><span class="o">.</span><span class="kp">array_equal</span><span class="p">(</span><span class="n">y_not_native_byteorder</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

<span class="c1"># The function fails if the data type is incorrect:</span>
<span class="n">x_incorrect_dtype</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="kp">astype</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">cos_module_np</span><span class="o">.</span><span class="n">cos_func_np</span><span class="p">(</span><span class="n">x_incorrect_dtype</span><span class="p">)</span>
    <span class="k">assert</span> <span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;This cannot be reached.&quot;</span>
<span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
    <span class="c1"># A TypeError will be raised, this can be changed by changing the</span>
    <span class="c1"># casting rule.</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>And this should result in the following figure:</p>
<p><img alt="" src="../../_images/test_cos_module_np.png" /></p>
</section>
</section>
<section id="ctypes">
<h2>Ctypes<a class="headerlink" href="#ctypes" title="Link to this heading">#</a></h2>
<p><a class="reference external" href="https://docs.python.org/3/library/ctypes.html">Ctypes</a> is a <em>foreign
function library</em> for Python. It provides C compatible data types, and allows
calling functions in DLLs or shared libraries. It can be used to wrap these
libraries in pure Python.</p>
<p><strong>Advantages</strong></p>
<ul class="simple">
<li><p>Part of the Python standard library</p></li>
<li><p>Does not need to be compiled</p></li>
<li><p>Wrapping code entirely in Python</p></li>
</ul>
<p><strong>Disadvantages</strong></p>
<ul class="simple">
<li><p>Requires code to be wrapped to be available as a shared library
(roughly speaking <code class="docutils literal notranslate"><span class="pre">*.dll</span></code> in Windows <code class="docutils literal notranslate"><span class="pre">*.so</span></code> in Linux and <code class="docutils literal notranslate"><span class="pre">*.dylib</span></code> in Mac OSX.)</p></li>
<li><p>No good support for C++</p></li>
</ul>
<section id="id1">
<h3>Example<a class="headerlink" href="#id1" title="Link to this heading">#</a></h3>
<p>As advertised, the wrapper code is in pure Python.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Example of wrapping cos function from math.h using ctypes.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">ctypes</span>

<span class="c1"># find and load the library</span>

<span class="c1"># OSX or linux</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ctypes.util</span><span class="w"> </span><span class="kn">import</span> <span class="n">find_library</span>

<span class="n">libm_name</span> <span class="o">=</span> <span class="n">find_library</span><span class="p">(</span><span class="s2">&quot;m&quot;</span><span class="p">)</span>
<span class="k">assert</span> <span class="n">libm_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Cannot find libm (math) on this system :/ That&#39;s bad.&quot;</span>

<span class="n">libm</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">cdll</span><span class="o">.</span><span class="n">LoadLibrary</span><span class="p">(</span><span class="n">libm_name</span><span class="p">)</span>

<span class="c1"># Windows</span>
<span class="c1"># from ctypes import windll</span>
<span class="c1"># libm = cdll.msvcrt</span>


<span class="c1"># set the argument type</span>
<span class="n">libm</span><span class="o">.</span><span class="n">cos</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span><span class="p">]</span>
<span class="c1"># set the return type</span>
<span class="n">libm</span><span class="o">.</span><span class="n">cos</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="n">ctypes</span><span class="o">.</span><span class="n">c_double</span>


<span class="k">def</span><span class="w"> </span><span class="nf">cos_func</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Wrapper for cos from math.h&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">libm</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Finding and loading the library may vary depending on your operating system,
check <a class="reference external" href="https://docs.python.org/3/library/ctypes.html#loading-dynamic-link-libraries">the documentation</a>
for details</p></li>
<li><p>This may be somewhat deceptive, since the math library exists in compiled
form on the system already. If you were to wrap a in-house library, you would
have to compile it first, which may or may not require some additional effort.</p></li>
</ul>
<p>We may now use this, as before:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [1]: </span><span class="kn">import</span><span class="w"> </span><span class="nn">cos_module</span>

<span class="gp">In [2]: </span>cos_module<span class="o">?</span>
<span class="go">Type:       module</span>
<span class="go">String Form:&lt;module &#39;cos_module&#39; from &#39;cos_module.py&#39;&gt;</span>
<span class="go">File:       /home/esc/git-working/scientific-python-lectures/advanced/interfacing_with_c/ctypes/cos_module.py</span>
<span class="go">Docstring:  &lt;no docstring&gt;</span>

<span class="gp">In [3]: </span><span class="nb">dir</span><span class="p">(</span><span class="n">cos_module</span><span class="p">)</span>
<span class="gh">Out[3]:</span>
<span class="go">[&#39;__builtins__&#39;,</span>
<span class="go"> &#39;__doc__&#39;,</span>
<span class="go"> &#39;__file__&#39;,</span>
<span class="go"> &#39;__name__&#39;,</span>
<span class="go"> &#39;__package__&#39;,</span>
<span class="go"> &#39;cos_func&#39;,</span>
<span class="go"> &#39;ctypes&#39;,</span>
<span class="go"> &#39;find_library&#39;,</span>
<span class="go"> &#39;libm&#39;]</span>

<span class="gp">In [4]: </span><span class="n">cos_module</span><span class="o">.</span><span class="n">cos_func</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<span class="gh">Out[4]: </span><span class="go">0.5403023058681398</span>

<span class="gp">In [5]: </span><span class="n">cos_module</span><span class="o">.</span><span class="n">cos_func</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<span class="gh">Out[5]: </span><span class="go">1.0</span>

<span class="gp">In [6]: </span><span class="n">cos_module</span><span class="o">.</span><span class="n">cos_func</span><span class="p">(</span><span class="mf">3.14159265359</span><span class="p">)</span>
<span class="gh">Out[6]: </span><span class="go">-1.0</span>
</pre></div>
</div>
<p>As with the previous example, this code is somewhat robust, although the error
message is not quite as helpful, since it does not tell us what the type should be.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span>

<span class="n">cos_module</span><span class="o">.</span><span class="n">cos_func</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="o">---------------------------------------------------------------------------</span>
<span class="n">ArgumentError</span>                             <span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">)</span>
<span class="o">&lt;</span><span class="n">ipython</span><span class="o">-</span><span class="nb">input</span><span class="o">-</span><span class="mi">7</span><span class="o">-</span><span class="mi">11</span><span class="n">bee483665d</span><span class="o">&gt;</span> <span class="ow">in</span> <span class="o">&lt;</span><span class="n">module</span><span class="o">&gt;</span><span class="p">()</span>
<span class="o">----&gt;</span> <span class="mi">1</span> <span class="n">cos_module</span><span class="o">.</span><span class="n">cos_func</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">esc</span><span class="o">/</span><span class="n">git</span><span class="o">-</span><span class="n">working</span><span class="o">/</span><span class="n">scientific</span><span class="o">-</span><span class="n">python</span><span class="o">-</span><span class="n">lectures</span><span class="o">/</span><span class="n">advanced</span><span class="o">/</span><span class="n">interfacing_with_c</span><span class="o">/</span><span class="n">ctypes</span><span class="o">/</span><span class="n">cos_module</span><span class="o">.</span><span class="n">py</span> <span class="ow">in</span> <span class="n">cos_func</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
     <span class="mi">12</span> <span class="k">def</span><span class="w"> </span><span class="nf">cos_func</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
     <span class="mi">13</span>     <span class="s1">&#39;&#39;&#39; Wrapper for cos from math.h &#39;&#39;&#39;</span>
<span class="o">---&gt;</span> <span class="mi">14</span>     <span class="k">return</span> <span class="n">libm</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
<span class="n">ArgumentError</span><span class="p">:</span> <span class="n">argument</span> <span class="mi">1</span><span class="p">:</span> <span class="o">&lt;</span><span class="nb">type</span> <span class="s1">&#39;exceptions.TypeError&#39;</span><span class="o">&gt;</span><span class="p">:</span> <span class="n">wrong</span> <span class="nb">type</span>
</pre></div>
</div>
</section>
<section id="id2">
<h3>NumPy Support<a class="headerlink" href="#id2" title="Link to this heading">#</a></h3>
<p>NumPy contains some support for interfacing with ctypes. In particular there is
support for exporting certain attributes of a NumPy array as ctypes data-types
and there are functions to convert from C arrays to NumPy arrays and back.</p>
<!---
XXX Should use {mod} and {class}
-->
<p>For more information, consult the corresponding section in the <a class="reference external" href="https://www.scipy.org/Cookbook/Ctypes">NumPy Cookbook</a> and the API documentation for
<a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.ndarray.ctypes.html">numpy.ndarray.ctypes</a>
and <a class="reference external" href="https://numpy.org/doc/stable/reference/routines.ctypeslib.html">numpy.ctypeslib</a>.</p>
<p>For the following example, let’s consider a C function in a library that takes
an input and an output array, computes the cosine of the input array and
stores the result in the output array.</p>
<p>The library consists of the following header file (although this is not
strictly needed for this example, we list it for completeness):</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">cos_doubles</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">in_array</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">out_array</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</pre></div>
</div>
<p>The function implementation resides in the following C source file:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span>

<span class="cm">/*  Compute the cosine of each element in in_array, storing the result in</span>
<span class="cm"> *  out_array. */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">cos_doubles</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">in_array</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">out_array</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">){</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
<span class="w">        </span><span class="n">out_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">in_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>And since the library is pure C, we can’t use <code class="docutils literal notranslate"><span class="pre">setuptools</span></code> to compile it, but
must use a combination of <code class="docutils literal notranslate"><span class="pre">make</span></code> and <code class="docutils literal notranslate"><span class="pre">gcc</span></code>:</p>
<div class="highlight-make notranslate"><div class="highlight"><pre><span></span><span class="nf">m.PHONY </span><span class="o">:</span><span class="w"> </span><span class="n">clean</span>

<span class="nf">libcos_doubles.so </span><span class="o">:</span><span class="w"> </span><span class="n">cos_doubles</span>.<span class="n">o</span>
<span class="w">	</span>gcc<span class="w"> </span>-shared<span class="w"> </span>-Wl,-soname,libcos_doubles.so<span class="w"> </span>-o<span class="w"> </span>libcos_doubles.so<span class="w"> </span>cos_doubles.o

<span class="nf">cos_doubles.o </span><span class="o">:</span><span class="w"> </span><span class="n">cos_doubles</span>.<span class="n">c</span>
<span class="w">	</span>gcc<span class="w"> </span>-c<span class="w"> </span>-fPIC<span class="w"> </span>cos_doubles.c<span class="w"> </span>-o<span class="w"> </span>cos_doubles.o

<span class="nf">clean </span><span class="o">:</span>
<span class="w">	</span>-rm<span class="w"> </span>-vf<span class="w"> </span>libcos_doubles.so<span class="w"> </span>cos_doubles.o<span class="w"> </span>cos_doubles.pyc
</pre></div>
</div>
<p>We can then compile this (on Linux) into the shared library
<code class="docutils literal notranslate"><span class="pre">libcos_doubles.so</span></code>:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls
<span class="go">cos_doubles.c  cos_doubles.h  cos_doubles.py  makefile  test_cos_doubles.py</span>
<span class="gp">$ </span>make
<span class="go">gcc -c -fPIC cos_doubles.c -o cos_doubles.o</span>
<span class="go">gcc -shared -Wl,-soname,libcos_doubles.so -o libcos_doubles.so cos_doubles.o</span>
<span class="gp">$ </span>ls
<span class="go">cos_doubles.c  cos_doubles.o   libcos_doubles.so*  test_cos_doubles.py</span>
<span class="go">cos_doubles.h  cos_doubles.py  makefile</span>
</pre></div>
</div>
<p>Now we can proceed to wrap this library via ctypes with direct support for
(certain kinds of) NumPy arrays:</p>
<div class="highlight-numpy notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot;Example of wrapping a C library function that accepts a C double array as</span>
<span class="sd">input using the numpy.ctypeslib.&quot;&quot;&quot;</span>

<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy.ctypeslib</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">npct</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">ctypes</span><span class="w"> </span><span class="kn">import</span> <span class="n">c_int</span>

<span class="c1"># input type for the cos_doubles function</span>
<span class="c1"># must be a double array, with single dimension that is contiguous</span>
<span class="n">array_1d_double</span> <span class="o">=</span> <span class="n">npct</span><span class="o">.</span><span class="n">ndpointer</span><span class="p">(</span><span class="kp">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">double</span><span class="p">,</span> <span class="kp">ndim</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">flags</span><span class="o">=</span><span class="s2">&quot;CONTIGUOUS&quot;</span><span class="p">)</span>

<span class="c1"># load the library, using NumPy mechanisms</span>
<span class="n">libcd</span> <span class="o">=</span> <span class="n">npct</span><span class="o">.</span><span class="n">load_library</span><span class="p">(</span><span class="s2">&quot;libcos_doubles&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">)</span>

<span class="c1"># setup the return types and argument types</span>
<span class="n">libcd</span><span class="o">.</span><span class="n">cos_doubles</span><span class="o">.</span><span class="n">restype</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">libcd</span><span class="o">.</span><span class="n">cos_doubles</span><span class="o">.</span><span class="n">argtypes</span> <span class="o">=</span> <span class="p">[</span><span class="n">array_1d_double</span><span class="p">,</span> <span class="n">array_1d_double</span><span class="p">,</span> <span class="n">c_int</span><span class="p">]</span>


<span class="k">def</span><span class="w"> </span><span class="nf">cos_doubles_func</span><span class="p">(</span><span class="n">in_array</span><span class="p">,</span> <span class="n">out_array</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">libcd</span><span class="o">.</span><span class="n">cos_doubles</span><span class="p">(</span><span class="n">in_array</span><span class="p">,</span> <span class="n">out_array</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">in_array</span><span class="p">))</span>
</pre></div>
</div>
<ul class="simple">
<li><p>Note the inherent limitation of contiguous single dimensional NumPy arrays,
since the C functions requires this kind of buffer.</p></li>
<li><p>Also note that the output array must be preallocated, for example with
<a class="reference external" href="https://numpy.org/doc/stable/reference/generated/numpy.zeros.html#numpy.zeros" title="(in NumPy v2.3)"><code class="xref py py-func docutils literal notranslate"><span class="pre">numpy.zeros()</span></code></a> and the function will write into it’s buffer.</p></li>
<li><p>Although the original signature of the <code class="docutils literal notranslate"><span class="pre">cos_doubles</span></code> function is <code class="docutils literal notranslate"><span class="pre">ARRAY,</span> <span class="pre">ARRAY,</span> <span class="pre">int</span></code> the final <code class="docutils literal notranslate"><span class="pre">cos_doubles_func</span></code> takes only two NumPy arrays as
arguments.</p></li>
</ul>
<p>And, as before, we convince ourselves that it worked:</p>
<div class="highlight-numpy notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cos_doubles</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">empty_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">cos_doubles</span><span class="o">.</span><span class="n">cos_doubles_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p><img alt="" src="../../_images/test_cos_doubles.png" /></p>
</section>
</section>
<section id="swig">
<h2>SWIG<a class="headerlink" href="#swig" title="Link to this heading">#</a></h2>
<p><a class="reference external" href="https://www.swig.org/">SWIG</a>, the Simplified Wrapper Interface Generator,
is a software development tool that connects programs written in C and C++
with a variety of high-level programming languages, including Python. The
important thing with SWIG is, that it can autogenerate the wrapper code for you.
While this is an advantage in terms of development time, it can also be a
burden. The generated file tend to be quite large and may not be too human
readable and the multiple levels of indirection which are a result of
the wrapping process, may be a bit tricky to understand.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The autogenerated C code uses the Python-C-Api.</p>
</div>
<p><strong>Advantages</strong></p>
<ul class="simple">
<li><p>Can automatically wrap entire libraries given the headers</p></li>
<li><p>Works nicely with C++</p></li>
</ul>
<p><strong>Disadvantages</strong></p>
<ul class="simple">
<li><p>Autogenerates enormous files</p></li>
<li><p>Hard to debug if something goes wrong</p></li>
<li><p>Steep learning curve</p></li>
</ul>
<section id="id3">
<h3>Example<a class="headerlink" href="#id3" title="Link to this heading">#</a></h3>
<p>Let’s imagine that our <code class="docutils literal notranslate"><span class="pre">cos</span></code> function lives in a <code class="docutils literal notranslate"><span class="pre">cos_module</span></code> which has
been written in <code class="docutils literal notranslate"><span class="pre">c</span></code> and consists of the source file <code class="docutils literal notranslate"><span class="pre">cos_module.c</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span>

<span class="kt">double</span><span class="w"> </span><span class="nf">cos_func</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">arg</span><span class="p">){</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>and the header file <code class="docutils literal notranslate"><span class="pre">cos_module.h</span></code>:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">double</span><span class="w"> </span><span class="nf">cos_func</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">arg</span><span class="p">);</span>
</pre></div>
</div>
<p>And our goal is to expose the <code class="docutils literal notranslate"><span class="pre">cos_func</span></code> to Python. To achieve this with
SWIG, we must write an <em>interface file</em> which contains the instructions for SWIG.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*  Example of wrapping cos function from math.h using SWIG. */</span>

<span class="o">%</span><span class="n">module</span><span class="w"> </span><span class="n">cos_module</span>
<span class="o">%</span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* the resulting C file should be built as a python extension */</span>
<span class="w">    </span><span class="cp">#define SWIG_FILE_WITH_INIT</span>
<span class="w">    </span><span class="cm">/*  Includes the header in the wrapper code */</span>
<span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cos_module.h&quot;</span>
<span class="o">%</span><span class="p">}</span>
<span class="cm">/*  Parse the header file to generate wrappers */</span>
<span class="o">%</span><span class="n">include</span><span class="w"> </span><span class="s">&quot;cos_module.h&quot;</span>
</pre></div>
</div>
<p>As you can see, not too much code is needed here. For this simple example it is
enough to simply include the header file in the interface file, to expose the
function to Python. However, SWIG does allow for more fine grained
inclusion/exclusion of functions found in header files, check the documentation
for details.</p>
<p>Generating the compiled wrappers is a two stage process:</p>
<ol class="arabic simple">
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">swig</span></code> executable on the interface file to generate the files
<code class="docutils literal notranslate"><span class="pre">cos_module_wrap.c</span></code>, which is the source file for the autogenerated Python
C-extension and <code class="docutils literal notranslate"><span class="pre">cos_module.py</span></code>, which is the autogenerated pure python
module.</p></li>
<li><p>Compile the <code class="docutils literal notranslate"><span class="pre">cos_module_wrap.c</span></code> into the <code class="docutils literal notranslate"><span class="pre">_cos_module.so</span></code>. Luckily,
<code class="docutils literal notranslate"><span class="pre">setuptools</span></code> knows how to handle SWIG interface files, so that our
<code class="docutils literal notranslate"><span class="pre">setup.py</span></code> is simply:</p></li>
</ol>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">setuptools</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">Extension</span>


<span class="n">setup</span><span class="p">(</span><span class="n">ext_modules</span><span class="o">=</span><span class="p">[</span><span class="n">Extension</span><span class="p">(</span><span class="s2">&quot;_cos_module&quot;</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cos_module.c&quot;</span><span class="p">,</span> <span class="s2">&quot;cos_module.i&quot;</span><span class="p">])])</span>
</pre></div>
</div>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>advanced/interfacing_with_c/swig

<span class="gp">$ </span>ls
<span class="go">cos_module.c  cos_module.h  cos_module.i  setup.py</span>

<span class="gp">$ </span>python<span class="w"> </span>setup.py<span class="w"> </span>build_ext<span class="w"> </span>--inplace
<span class="go">running build_ext</span>
<span class="go">building &#39;_cos_module&#39; extension</span>
<span class="go">swigging cos_module.i to cos_module_wrap.c</span>
<span class="go">swig -python -o cos_module_wrap.c cos_module.i</span>
<span class="go">creating build</span>
<span class="go">creating build/temp.linux-x86_64-2.7</span>
<span class="go">gcc -pthread -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -fPIC -I/home/esc/anaconda/include/python2.7 -c cos_module.c -o build/temp.linux-x86_64-2.7/cos_module.o</span>
<span class="go">gcc -pthread -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -fPIC -I/home/esc/anaconda/include/python2.7 -c cos_module_wrap.c -o build/temp.linux-x86_64-2.7/cos_module_wrap.o</span>
<span class="go">gcc -pthread -shared build/temp.linux-x86_64-2.7/cos_module.o build/temp.linux-x86_64-2.7/cos_module_wrap.o -L/home/esc/anaconda/lib -lpython2.7 -o /home/esc/git-working/scientific-python-lectures/advanced/interfacing_with_c/swig/_cos_module.so</span>

<span class="gp">$ </span>ls
<span class="go">build/  cos_module.c  cos_module.h  cos_module.i  cos_module.py  _cos_module.so*  cos_module_wrap.c  setup.py</span>
</pre></div>
</div>
<p>We can now load and execute the <code class="docutils literal notranslate"><span class="pre">cos_module</span></code> as we have done in the previous examples:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [1]: </span><span class="kn">import</span><span class="w"> </span><span class="nn">cos_module</span>

<span class="gp">In [2]: </span>cos_module<span class="o">?</span>
<span class="go">Type:       module</span>
<span class="go">String Form:&lt;module &#39;cos_module&#39; from &#39;cos_module.py&#39;&gt;</span>
<span class="go">File:       /home/esc/git-working/scientific-python-lectures/advanced/interfacing_with_c/swig/cos_module.py</span>
<span class="go">Docstring:  &lt;no docstring&gt;</span>

<span class="gp">In [3]: </span><span class="nb">dir</span><span class="p">(</span><span class="n">cos_module</span><span class="p">)</span>
<span class="gh">Out[3]:</span>
<span class="go">[&#39;__builtins__&#39;,</span>
<span class="go"> &#39;__doc__&#39;,</span>
<span class="go"> &#39;__file__&#39;,</span>
<span class="go"> &#39;__name__&#39;,</span>
<span class="go"> &#39;__package__&#39;,</span>
<span class="go"> &#39;_cos_module&#39;,</span>
<span class="go"> &#39;_newclass&#39;,</span>
<span class="go"> &#39;_object&#39;,</span>
<span class="go"> &#39;_swig_getattr&#39;,</span>
<span class="go"> &#39;_swig_property&#39;,</span>
<span class="go"> &#39;_swig_repr&#39;,</span>
<span class="go"> &#39;_swig_setattr&#39;,</span>
<span class="go"> &#39;_swig_setattr_nondynamic&#39;,</span>
<span class="go"> &#39;cos_func&#39;]</span>

<span class="gp">In [4]: </span><span class="n">cos_module</span><span class="o">.</span><span class="n">cos_func</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<span class="gh">Out[4]: </span><span class="go">0.5403023058681398</span>

<span class="gp">In [5]: </span><span class="n">cos_module</span><span class="o">.</span><span class="n">cos_func</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<span class="gh">Out[5]: </span><span class="go">1.0</span>

<span class="gp">In [6]: </span><span class="n">cos_module</span><span class="o">.</span><span class="n">cos_func</span><span class="p">(</span><span class="mf">3.14159265359</span><span class="p">)</span>
<span class="gh">Out[6]: </span><span class="go">-1.0</span>
</pre></div>
</div>
<p>Again we test for robustness, and we see that we get a better error message
(although, strictly speaking in Python there is no <code class="docutils literal notranslate"><span class="pre">double</span></code> type):</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [7]: </span><span class="n">cos_module</span><span class="o">.</span><span class="n">cos_func</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">&lt;ipython-input-7-11bee483665d&gt;</span> in <span class="ni">&lt;module&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">cos_module</span><span class="o">.</span><span class="n">cos_func</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="ne">TypeError</span>: in method &#39;cos_func&#39;, argument 1 of type &#39;double&#39;
</pre></div>
</div>
</section>
<section id="id4">
<h3>NumPy Support<a class="headerlink" href="#id4" title="Link to this heading">#</a></h3>
<p>NumPy provides <a class="reference external" href="https://numpy.org/doc/stable/reference/swig.html">support for SWIG</a> with the <code class="docutils literal notranslate"><span class="pre">numpy.i</span></code>
file. This interface file defines various so-called <em>typemaps</em> which support
conversion between NumPy arrays and C-Arrays. In the following example we will
take a quick look at how such typemaps work in practice.</p>
<p>We have the same <code class="docutils literal notranslate"><span class="pre">cos_doubles</span></code> function as in the ctypes example:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">cos_doubles</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">in_array</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">out_array</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span>

<span class="cm">/*  Compute the cosine of each element in in_array, storing the result in</span>
<span class="cm"> *  out_array. */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">cos_doubles</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">in_array</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">out_array</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">){</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
<span class="w">        </span><span class="n">out_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">in_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is wrapped as <code class="docutils literal notranslate"><span class="pre">cos_doubles_func</span></code> using the following SWIG interface
file:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cm">/*  Example of wrapping a C function that takes a C double array as input using</span>
<span class="cm"> *  NumPy typemaps for SWIG. */</span>

<span class="o">%</span><span class="n">module</span><span class="w"> </span><span class="n">cos_doubles</span>
<span class="o">%</span><span class="p">{</span>
<span class="w">    </span><span class="cm">/* the resulting C file should be built as a python extension */</span>
<span class="w">    </span><span class="cp">#define SWIG_FILE_WITH_INIT</span>
<span class="w">    </span><span class="cm">/*  Includes the header in the wrapper code */</span>
<span class="w">    </span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&quot;cos_doubles.h&quot;</span>
<span class="o">%</span><span class="p">}</span>

<span class="cm">/*  include the NumPy typemaps */</span>
<span class="o">%</span><span class="n">include</span><span class="w"> </span><span class="s">&quot;numpy.i&quot;</span>
<span class="cm">/*  need this for correct module initialization */</span>
<span class="o">%</span><span class="n">init</span><span class="w"> </span><span class="o">%</span><span class="p">{</span>
<span class="w">    </span><span class="n">import_array</span><span class="p">();</span>
<span class="o">%</span><span class="p">}</span>

<span class="cm">/*  typemaps for the two arrays, the second will be modified in-place */</span>
<span class="o">%</span><span class="n">apply</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">IN_ARRAY1</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">DIM1</span><span class="p">)</span><span class="w"> </span><span class="p">{(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">in_array</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size_in</span><span class="p">)}</span>
<span class="o">%</span><span class="n">apply</span><span class="w"> </span><span class="p">(</span><span class="kt">double</span><span class="o">*</span><span class="w"> </span><span class="n">INPLACE_ARRAY1</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">DIM1</span><span class="p">)</span><span class="w"> </span><span class="p">{(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">out_array</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size_out</span><span class="p">)}</span>

<span class="cm">/*  Wrapper for cos_doubles that massages the types */</span>
<span class="o">%</span><span class="kr">inline</span><span class="w"> </span><span class="o">%</span><span class="p">{</span>
<span class="w">    </span><span class="cm">/*  takes as input two NumPy arrays */</span>
<span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">cos_doubles_func</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">in_array</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size_in</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">out_array</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size_out</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="cm">/*  calls the original function, providing only the size of the first */</span>
<span class="w">        </span><span class="n">cos_doubles</span><span class="p">(</span><span class="n">in_array</span><span class="p">,</span><span class="w"> </span><span class="n">out_array</span><span class="p">,</span><span class="w"> </span><span class="n">size_in</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
<ul class="simple">
<li><p>To use the NumPy typemaps, we need include the <code class="docutils literal notranslate"><span class="pre">numpy.i</span></code> file.</p></li>
<li><p>Observe the call to <code class="docutils literal notranslate"><span class="pre">import_array()</span></code> which we encountered already in the
NumPy-C-API example.</p></li>
<li><p>Since the type maps only support the signature <code class="docutils literal notranslate"><span class="pre">ARRAY,</span> <span class="pre">SIZE</span></code> we need to
wrap the <code class="docutils literal notranslate"><span class="pre">cos_doubles</span></code> as <code class="docutils literal notranslate"><span class="pre">cos_doubles_func</span></code> which takes two arrays
including sizes as input.</p></li>
<li><p>As opposed to the simple SWIG example, we don’t include the <code class="docutils literal notranslate"><span class="pre">cos_doubles.h</span></code>
header, There is nothing there that we wish to expose to Python since we
expose the functionality through <code class="docutils literal notranslate"><span class="pre">cos_doubles_func</span></code>.</p></li>
</ul>
<p>And, as before we can use <code class="docutils literal notranslate"><span class="pre">setuptools</span></code> to wrap this:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">setuptools</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">Extension</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>


<span class="n">setup</span><span class="p">(</span>
    <span class="n">ext_modules</span><span class="o">=</span><span class="p">[</span>
        <span class="n">Extension</span><span class="p">(</span>
            <span class="s2">&quot;_cos_doubles&quot;</span><span class="p">,</span>
            <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cos_doubles.c&quot;</span><span class="p">,</span> <span class="s2">&quot;cos_doubles.i&quot;</span><span class="p">],</span>
            <span class="n">include_dirs</span><span class="o">=</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">get_include</span><span class="p">()],</span>
        <span class="p">)</span>
    <span class="p">]</span>
<span class="p">)</span>
</pre></div>
</div>
<p>As previously, we need to use <code class="docutils literal notranslate"><span class="pre">include_dirs</span></code> to specify the location.</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls
<span class="go">cos_doubles.c  cos_doubles.h  cos_doubles.i  numpy.i  setup.py  test_cos_doubles.py</span>
<span class="gp">$ </span>python<span class="w"> </span>setup.py<span class="w"> </span>build_ext<span class="w"> </span>-i
<span class="go">running build_ext</span>
<span class="go">building &#39;_cos_doubles&#39; extension</span>
<span class="go">swigging cos_doubles.i to cos_doubles_wrap.c</span>
<span class="go">swig -python -o cos_doubles_wrap.c cos_doubles.i</span>
<span class="go">cos_doubles.i:24: Warning(490): Fragment &#39;NumPy_Backward_Compatibility&#39; not found.</span>
<span class="go">cos_doubles.i:24: Warning(490): Fragment &#39;NumPy_Backward_Compatibility&#39; not found.</span>
<span class="go">cos_doubles.i:24: Warning(490): Fragment &#39;NumPy_Backward_Compatibility&#39; not found.</span>
<span class="go">creating build</span>
<span class="go">creating build/temp.linux-x86_64-2.7</span>
<span class="go">gcc -pthread -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -fPIC -I/home/esc/anaconda/lib/python2.7/site-packages/numpy/core/include -I/home/esc/anaconda/include/python2.7 -c cos_doubles.c -o build/temp.linux-x86_64-2.7/cos_doubles.o</span>
<span class="go">gcc -pthread -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -fPIC -I/home/esc/anaconda/lib/python2.7/site-packages/numpy/core/include -I/home/esc/anaconda/include/python2.7 -c cos_doubles_wrap.c -o build/temp.linux-x86_64-2.7/cos_doubles_wrap.o</span>
<span class="go">In file included from /home/esc/anaconda/lib/python2.7/site-packages/numpy/core/include/numpy/ndarraytypes.h:1722,</span>
<span class="go">                 from /home/esc/anaconda/lib/python2.7/site-packages/numpy/core/include/numpy/ndarrayobject.h:17,</span>
<span class="go">                 from /home/esc/anaconda/lib/python2.7/site-packages/numpy/core/include/numpy/arrayobject.h:15,</span>
<span class="go">                 from cos_doubles_wrap.c:2706:</span>
<span class="go">/home/esc/anaconda/lib/python2.7/site-packages/numpy/core/include/numpy/npy_deprecated_api.h:11:2: warning: #warning &quot;Using deprecated NumPy API, disable it by #defining NPY_NO_DEPRECATED_API NPY_1_7_API_VERSION&quot;</span>
<span class="go">gcc -pthread -shared build/temp.linux-x86_64-2.7/cos_doubles.o build/temp.linux-x86_64-2.7/cos_doubles_wrap.o -L/home/esc/anaconda/lib -lpython2.7 -o /home/esc/git-working/scientific-python-lectures/advanced/interfacing_with_c/swig_numpy/_cos_doubles.so</span>
<span class="gp">$ </span>ls
<span class="go">build/         cos_doubles.h  cos_doubles.py    cos_doubles_wrap.c  setup.py</span>
<span class="go">cos_doubles.c  cos_doubles.i  _cos_doubles.so*  numpy.i             test_cos_doubles.py</span>
</pre></div>
</div>
<p>And, as before, we convince ourselves that it worked:</p>
<div class="highlight-numpy notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cos_doubles</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">empty_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">cos_doubles</span><span class="o">.</span><span class="n">cos_doubles_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p><img alt="" src="../../_images/test_cos_doubles.png" /></p>
</section>
</section>
<section id="cython">
<h2>Cython<a class="headerlink" href="#cython" title="Link to this heading">#</a></h2>
<p><a class="reference external" href="https://cython.org/">Cython</a> is both a Python-like language for writing
C-extensions and an advanced compiler for this language. The Cython <em>language</em>
is a superset of Python, which comes with additional constructs that allow you
call C functions and annotate variables and class attributes with c types. In
this sense one could also call it a <em>Python with types</em>.</p>
<p>In addition to the basic use case of wrapping native code, Cython supports an
additional use-case, namely interactive optimization. Basically, one starts out
with a pure-Python script and incrementally adds Cython types to the bottleneck
code to optimize only those code paths that really matter.</p>
<p>In this sense it is quite similar to SWIG, since the code can be autogenerated
but in a sense it also quite similar to ctypes since the wrapping code can
(almost) be written in Python.</p>
<p>While others solutions that autogenerate code can be quite difficult to debug
(for example SWIG) Cython comes with an extension to the GNU debugger that
helps debug Python, Cython and C code.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The autogenerated C code uses the Python-C-Api.</p>
</div>
<p><strong>Advantages</strong></p>
<ul class="simple">
<li><p>Python like language for writing C-extensions</p></li>
<li><p>Autogenerated code</p></li>
<li><p>Supports incremental optimization</p></li>
<li><p>Includes a GNU debugger extension</p></li>
<li><p>Support for C++ (Since version 0.13)</p></li>
</ul>
<p><strong>Disadvantages</strong></p>
<ul class="simple">
<li><p>Must be compiled</p></li>
<li><p>Requires an additional library ( but only at build time, at this problem can be
overcome by shipping the generated C files)</p></li>
</ul>
<section id="id5">
<h3>Example<a class="headerlink" href="#id5" title="Link to this heading">#</a></h3>
<p>The main Cython code for our <code class="docutils literal notranslate"><span class="pre">cos_module</span></code> is contained in the file
<code class="docutils literal notranslate"><span class="pre">cos_module.pyx</span></code>:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot; Example of wrapping cos function from math.h using Cython. &quot;&quot;&quot;</span>

<span class="k">cdef</span><span class="w"> </span><span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;math.h&quot;</span><span class="p">:</span>
    <span class="n">double</span> <span class="n">cos</span><span class="p">(</span><span class="n">double</span> <span class="n">arg</span><span class="p">)</span>

<span class="k">def</span><span class="w"> </span><span class="nf">cos_func</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">cos</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</pre></div>
</div>
<p>Note the additional keywords such as <code class="docutils literal notranslate"><span class="pre">cdef</span></code> and <code class="docutils literal notranslate"><span class="pre">extern</span></code>. Also the
<code class="docutils literal notranslate"><span class="pre">cos_func</span></code> is then pure Python.</p>
<p>Again we can use the standard <code class="docutils literal notranslate"><span class="pre">setuptools</span></code> module, but this time we need some
additional pieces from <code class="docutils literal notranslate"><span class="pre">Cython.Build</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">setuptools</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">Extension</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Cython.Build</span><span class="w"> </span><span class="kn">import</span> <span class="n">cythonize</span>


<span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span><span class="n">Extension</span><span class="p">(</span><span class="s2">&quot;cos_module&quot;</span><span class="p">,</span> <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;cos_module.pyx&quot;</span><span class="p">])]</span>

<span class="n">setup</span><span class="p">(</span><span class="n">ext_modules</span><span class="o">=</span><span class="n">cythonize</span><span class="p">(</span><span class="n">extensions</span><span class="p">))</span>
</pre></div>
</div>
<p>Compiling this:</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>advanced/interfacing_with_c/cython
<span class="gp">$ </span>ls
<span class="go">cos_module.pyx  setup.py</span>
<span class="gp">$ </span>python<span class="w"> </span>setup.py<span class="w"> </span>build_ext<span class="w"> </span>--inplace
<span class="go">running build_ext</span>
<span class="go">cythoning cos_module.pyx to cos_module.c</span>
<span class="go">building &#39;cos_module&#39; extension</span>
<span class="go">creating build</span>
<span class="go">creating build/temp.linux-x86_64-2.7</span>
<span class="go">gcc -pthread -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -fPIC -I/home/esc/anaconda/include/python2.7 -c cos_module.c -o build/temp.linux-x86_64-2.7/cos_module.o</span>
<span class="go">gcc -pthread -shared build/temp.linux-x86_64-2.7/cos_module.o -L/home/esc/anaconda/lib -lpython2.7 -o /home/esc/git-working/scientific-python-lectures/advanced/interfacing_with_c/cython/cos_module.so</span>
<span class="gp">$ </span>ls
<span class="go">build/  cos_module.c  cos_module.pyx  cos_module.so*  setup.py</span>
</pre></div>
</div>
<p>And running it:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [1]: </span><span class="kn">import</span><span class="w"> </span><span class="nn">cos_module</span>

<span class="gp">In [2]: </span>cos_module<span class="o">?</span>
<span class="go">Type:       module</span>
<span class="go">String Form:&lt;module &#39;cos_module&#39; from &#39;cos_module.so&#39;&gt;</span>
<span class="go">File:       /home/esc/git-working/scientific-python-lectures/advanced/interfacing_with_c/cython/cos_module.so</span>
<span class="go">Docstring:  &lt;no docstring&gt;</span>

<span class="gp">In [3]: </span><span class="nb">dir</span><span class="p">(</span><span class="n">cos_module</span><span class="p">)</span>
<span class="gh">Out[3]:</span>
<span class="go">[&#39;__builtins__&#39;,</span>
<span class="go"> &#39;__doc__&#39;,</span>
<span class="go"> &#39;__file__&#39;,</span>
<span class="go"> &#39;__name__&#39;,</span>
<span class="go"> &#39;__package__&#39;,</span>
<span class="go"> &#39;__test__&#39;,</span>
<span class="go"> &#39;cos_func&#39;]</span>

<span class="gp">In [4]: </span><span class="n">cos_module</span><span class="o">.</span><span class="n">cos_func</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>
<span class="gh">Out[4]: </span><span class="go">0.5403023058681398</span>

<span class="gp">In [5]: </span><span class="n">cos_module</span><span class="o">.</span><span class="n">cos_func</span><span class="p">(</span><span class="mf">0.0</span><span class="p">)</span>
<span class="gh">Out[5]: </span><span class="go">1.0</span>

<span class="gp">In [6]: </span><span class="n">cos_module</span><span class="o">.</span><span class="n">cos_func</span><span class="p">(</span><span class="mf">3.14159265359</span><span class="p">)</span>
<span class="gh">Out[6]: </span><span class="go">-1.0</span>
</pre></div>
</div>
<p>And, testing a little for robustness, we can see that we get good error messages:</p>
<div class="highlight-ipython notranslate"><div class="highlight"><pre><span></span><span class="gp">In [7]: </span><span class="n">cos_module</span><span class="o">.</span><span class="n">cos_func</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">TypeError</span><span class="g g-Whitespace">                                 </span>Traceback (most recent call last)
<span class="nn">&lt;ipython-input-7-11bee483665d&gt;</span> in <span class="ni">&lt;module&gt;</span><span class="nt">()</span>
<span class="ne">----&gt; </span><span class="mi">1</span> <span class="n">cos_module</span><span class="o">.</span><span class="n">cos_func</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">)</span>
<span class="nn">/home/esc/git-working/scientific-python-lectures/advanced/interfacing_with_c/cython/cos_module.so</span> in <span class="ni">cos_module.cos_func (cos_module.c:506)</span><span class="nt">()</span>
<span class="ne">TypeError</span>: a float is required
</pre></div>
</div>
<p>Additionally, it is worth noting that <code class="docutils literal notranslate"><span class="pre">Cython</span></code> ships with complete
declarations for the C math library, which simplifies the code above to become:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot; Simpler example of wrapping cos function from math.h using Cython. &quot;&quot;&quot;</span>

<span class="k">from</span><span class="w"> </span><span class="nn">libc.math</span><span class="w"> </span><span class="k">cimport</span> <span class="n">cos</span>

<span class="k">def</span><span class="w"> </span><span class="nf">cos_func</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">cos</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
</pre></div>
</div>
<p>In this case the <code class="docutils literal notranslate"><span class="pre">cimport</span></code> statement is used to import the <code class="docutils literal notranslate"><span class="pre">cos</span></code> function.</p>
</section>
<section id="id6">
<h3>NumPy Support<a class="headerlink" href="#id6" title="Link to this heading">#</a></h3>
<p>Cython has support for NumPy via the <code class="docutils literal notranslate"><span class="pre">numpy.pyx</span></code> file which allows you to add
the NumPy array type to your Cython code. I.e. like specifying that variable
<code class="docutils literal notranslate"><span class="pre">i</span></code> is of type <code class="docutils literal notranslate"><span class="pre">int</span></code>, you can specify that variable <code class="docutils literal notranslate"><span class="pre">a</span></code> is of type
<code class="docutils literal notranslate"><span class="pre">numpy.ndarray</span></code> with a given <code class="docutils literal notranslate"><span class="pre">dtype</span></code>. Also, certain optimizations such as
bounds checking are supported. Look at the corresponding section in the <a class="reference external" href="https://docs.cython.org/en/latest/src/tutorial/numpy.html">Cython
documentation</a>. In case you
want to pass NumPy arrays as C arrays to your Cython wrapped C functions, there
is a <a class="reference external" href="https://docs.cython.org/en/latest/src/userguide/memoryviews.html#pass-data-from-a-c-function-via-pointer">section about this in the Cython documentation</a>.</p>
<p>In the following example, we will show how to wrap the familiar <code class="docutils literal notranslate"><span class="pre">cos_doubles</span></code>
function using Cython.</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span><span class="w"> </span><span class="nf">cos_doubles</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">in_array</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">out_array</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">);</span>
</pre></div>
</div>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;math.h&gt;</span>

<span class="cm">/*  Compute the cosine of each element in in_array, storing the result in</span>
<span class="cm"> *  out_array. */</span>
<span class="kt">void</span><span class="w"> </span><span class="nf">cos_doubles</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">in_array</span><span class="p">,</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">out_array</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">size</span><span class="p">){</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">size</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
<span class="w">        </span><span class="n">out_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cos</span><span class="p">(</span><span class="n">in_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This is wrapped as <code class="docutils literal notranslate"><span class="pre">cos_doubles_func</span></code> using the following Cython code:</p>
<div class="highlight-cython notranslate"><div class="highlight"><pre><span></span><span class="sd">&quot;&quot;&quot; Example of wrapping a C function that takes C double arrays as input using</span>
<span class="sd">    the NumPy declarations from Cython &quot;&quot;&quot;</span>

<span class="c"># cimport the Cython declarations for NumPy</span>
<span class="k">cimport</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>

<span class="c"># if you want to use the NumPy-C-API from Cython</span>
<span class="c"># (not strictly necessary for this example, but good practice)</span>
<span class="n">np</span><span class="o">.</span><span class="n">import_array</span><span class="p">()</span>

<span class="c"># cdefine the signature of our c function</span>
<span class="k">cdef</span><span class="w"> </span><span class="kr">extern</span> <span class="k">from</span> <span class="s">&quot;cos_doubles.h&quot;</span><span class="p">:</span>
    <span class="n">void</span> <span class="n">cos_doubles</span> <span class="p">(</span><span class="n">double</span> <span class="o">*</span> <span class="n">in_array</span><span class="p">,</span> <span class="n">double</span> <span class="o">*</span> <span class="n">out_array</span><span class="p">,</span> <span class="nb">int</span> <span class="n">size</span><span class="p">)</span>

<span class="c"># create the wrapper code, with NumPy type annotations</span>
<span class="k">def</span><span class="w"> </span><span class="nf">cos_doubles_func</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">double</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mf">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;c&quot;</span><span class="p">]</span> <span class="n">in_array</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">,</span>
                     <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">[</span><span class="n">double</span><span class="p">,</span> <span class="n">ndim</span><span class="o">=</span><span class="mf">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s">&quot;c&quot;</span><span class="p">]</span> <span class="n">out_array</span> <span class="ow">not</span> <span class="bp">None</span><span class="p">):</span>
    <span class="n">cos_doubles</span><span class="p">(</span><span class="o">&lt;</span><span class="n">double</span><span class="o">*&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">PyArray_DATA</span><span class="p">(</span><span class="n">in_array</span><span class="p">),</span>
                <span class="o">&lt;</span><span class="n">double</span><span class="o">*&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">PyArray_DATA</span><span class="p">(</span><span class="n">out_array</span><span class="p">),</span>
                <span class="n">in_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mf">0</span><span class="p">])</span>
</pre></div>
</div>
<p>And can be compiled using <code class="docutils literal notranslate"><span class="pre">setuptools</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">setuptools</span><span class="w"> </span><span class="kn">import</span> <span class="n">setup</span><span class="p">,</span> <span class="n">Extension</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">Cython.Build</span><span class="w"> </span><span class="kn">import</span> <span class="n">cythonize</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>


<span class="n">extensions</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">Extension</span><span class="p">(</span>
        <span class="s2">&quot;cos_doubles&quot;</span><span class="p">,</span>
        <span class="n">sources</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;_cos_doubles.pyx&quot;</span><span class="p">,</span> <span class="s2">&quot;cos_doubles.c&quot;</span><span class="p">],</span>
        <span class="n">include_dirs</span><span class="o">=</span><span class="p">[</span><span class="n">numpy</span><span class="o">.</span><span class="n">get_include</span><span class="p">()],</span>
    <span class="p">)</span>
<span class="p">]</span>

<span class="n">setup</span><span class="p">(</span><span class="n">ext_modules</span><span class="o">=</span><span class="n">cythonize</span><span class="p">(</span><span class="n">extensions</span><span class="p">))</span>
</pre></div>
</div>
<ul class="simple">
<li><p>As with the previous compiled NumPy examples, we need the <code class="docutils literal notranslate"><span class="pre">include_dirs</span></code> option.</p></li>
</ul>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>ls
<span class="go">cos_doubles.c  cos_doubles.h  _cos_doubles.pyx  setup.py  test_cos_doubles.py</span>
<span class="gp">$ </span>python<span class="w"> </span>setup.py<span class="w"> </span>build_ext<span class="w"> </span>-i
<span class="go">running build_ext</span>
<span class="go">cythoning _cos_doubles.pyx to _cos_doubles.c</span>
<span class="go">building &#39;cos_doubles&#39; extension</span>
<span class="go">creating build</span>
<span class="go">creating build/temp.linux-x86_64-2.7</span>
<span class="go">gcc -pthread -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -fPIC -I/home/esc/anaconda/lib/python2.7/site-packages/numpy/core/include -I/home/esc/anaconda/include/python2.7 -c _cos_doubles.c -o build/temp.linux-x86_64-2.7/_cos_doubles.o</span>
<span class="go">In file included from /home/esc/anaconda/lib/python2.7/site-packages/numpy/core/include/numpy/ndarraytypes.h:1722,</span>
<span class="go">                 from /home/esc/anaconda/lib/python2.7/site-packages/numpy/core/include/numpy/ndarrayobject.h:17,</span>
<span class="go">                 from /home/esc/anaconda/lib/python2.7/site-packages/numpy/core/include/numpy/arrayobject.h:15,</span>
<span class="go">                 from _cos_doubles.c:253:</span>
<span class="go">/home/esc/anaconda/lib/python2.7/site-packages/numpy/core/include/numpy/npy_deprecated_api.h:11:2: warning: #warning &quot;Using deprecated NumPy API, disable it by #defining NPY_NO_DEPRECATED_API NPY_1_7_API_VERSION&quot;</span>
<span class="go">/home/esc/anaconda/lib/python2.7/site-packages/numpy/core/include/numpy/__ufunc_api.h:236: warning: ‘_import_umath’ defined but not used</span>
<span class="go">gcc -pthread -fno-strict-aliasing -g -O2 -DNDEBUG -g -fwrapv -O3 -Wall -Wstrict-prototypes -fPIC -I/home/esc/anaconda/lib/python2.7/site-packages/numpy/core/include -I/home/esc/anaconda/include/python2.7 -c cos_doubles.c -o build/temp.linux-x86_64-2.7/cos_doubles.o</span>
<span class="go">gcc -pthread -shared build/temp.linux-x86_64-2.7/_cos_doubles.o build/temp.linux-x86_64-2.7/cos_doubles.o -L/home/esc/anaconda/lib -lpython2.7 -o /home/esc/git-working/scientific-python-lectures/advanced/interfacing_with_c/cython_numpy/cos_doubles.so</span>
<span class="gp">$ </span>ls
<span class="go">build/  _cos_doubles.c  cos_doubles.c  cos_doubles.h  _cos_doubles.pyx  cos_doubles.so*  setup.py  test_cos_doubles.py</span>
</pre></div>
</div>
<p>And, as before, we convince ourselves that it worked:</p>
<div class="highlight-numpy notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">matplotlib.pyplot</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">plt</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">cos_doubles</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="kp">empty_like</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

<span class="n">cos_doubles</span><span class="o">.</span><span class="n">cos_doubles_func</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
<p><img alt="" src="../../_images/test_cos_doubles.png" /></p>
</section>
</section>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Link to this heading">#</a></h2>
<p>In this section four different techniques for interfacing with native code
have been presented. The table below roughly summarizes some of the aspects of
the techniques.</p>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>x</p></th>
<th class="head"><p>Part of CPython</p></th>
<th class="head"><p>Compiled</p></th>
<th class="head"><p>Autogenerated</p></th>
<th class="head"><p>NumPy Support</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>Python-C-API</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">True</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">True</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">False</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">True</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Ctypes</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">True</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">False</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">False</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">True</span></code></p></td>
</tr>
<tr class="row-even"><td><p>Swig</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">False</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">True</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">True</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">True</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>Cython</p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">False</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">True</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">True</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">True</span></code></p></td>
</tr>
</tbody>
</table>
</div>
<p>Of all three presented techniques, Cython is the most modern and advanced. In
particular, the ability to optimize code incrementally by adding types to your
Python code is unique.</p>
</section>
<section id="further-reading-and-references">
<h2>Further Reading and References<a class="headerlink" href="#further-reading-and-references" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://gael-varoquaux.info/programming/cython-example-of-exposing-c-computed-arrays-in-python-without-data-copies.html">Gaël Varoquaux’s blog post about avoiding data copies</a> provides some insight on how to
handle memory management cleverly. If you ever run into issues with large
datasets, this is a reference to come back to for some inspiration.</p></li>
</ul>
</section>
<section id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Link to this heading">#</a></h2>
<p>Since this is a brand new section, the exercises are considered more as
pointers as to what to look at next, so pick the ones that you find more
interesting. If you have good ideas for exercises, please let us know!</p>
<ol class="arabic simple">
<li><p>Download the source code for each example and compile and run them on your
machine.</p></li>
<li><p>Make trivial changes to each example and convince yourself that this works. (
E.g. change <code class="docutils literal notranslate"><span class="pre">cos</span></code> for <code class="docutils literal notranslate"><span class="pre">sin</span></code>.)</p></li>
<li><p>Most of the examples, especially the ones involving NumPy may still be
fragile and respond badly to input errors. Look for ways to crash the
examples, figure what the problem is and devise a potential solution.
Here are some ideas:</p>
<ol class="arabic simple">
<li><p>Numerical overflow.</p></li>
<li><p>Input and output arrays that have different lengths.</p></li>
<li><p>Multidimensional array.</p></li>
<li><p>Empty array</p></li>
<li><p>Arrays with non-<code class="docutils literal notranslate"><span class="pre">double</span></code> types</p></li>
</ol>
</li>
<li><p>Use the <code class="docutils literal notranslate"><span class="pre">%timeit</span></code> IPython magic to measure the execution time of the
various solutions</p></li>
</ol>
<section id="id7">
<h3>Python-C-API<a class="headerlink" href="#id7" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>Modify the NumPy example such that the function takes two input arguments, where
the second is the preallocated output array, making it similar to the other NumPy examples.</p></li>
<li><p>Modify the example such that the function only takes a single input array
and modifies this in place.</p></li>
<li><p>Try to fix the example to use the new <a class="reference external" href="https://numpy.org/doc/stable/reference/c-api/iterator.html">NumPy iterator protocol</a>. If you
manage to obtain a working solution, please submit a pull-request on github.</p></li>
<li><p>You may have noticed, that the NumPy-C-API example is the only NumPy example
that does not wrap <code class="docutils literal notranslate"><span class="pre">cos_doubles</span></code> but instead applies the <code class="docutils literal notranslate"><span class="pre">cos</span></code> function
directly to the elements of the NumPy array. Does this have any advantages
over the other techniques.</p></li>
<li><p>Can you wrap <code class="docutils literal notranslate"><span class="pre">cos_doubles</span></code> using only the NumPy-C-API. You may need to
ensure that the arrays have the correct type, are one dimensional and
contiguous in memory.</p></li>
</ol>
</section>
<section id="id8">
<h3>Ctypes<a class="headerlink" href="#id8" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>Modify the NumPy example such that <code class="docutils literal notranslate"><span class="pre">cos_doubles_func</span></code> handles the preallocation for
you, thus making it more like the NumPy-C-API example.</p></li>
</ol>
</section>
<section id="id9">
<h3>SWIG<a class="headerlink" href="#id9" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>Look at the code that SWIG autogenerates, how much of it do you
understand?</p></li>
<li><p>Modify the NumPy example such that <code class="docutils literal notranslate"><span class="pre">cos_doubles_func</span></code> handles the preallocation for
you, thus making it more like the NumPy-C-API example.</p></li>
<li><p>Modify the <code class="docutils literal notranslate"><span class="pre">cos_doubles</span></code> C function so that it returns an allocated array.
Can you wrap this using SWIG typemaps? If not, why not? Is there a
workaround for this specific situation? (Hint: you know the size of the
output array, so it may be possible to construct a NumPy array from the
returned <code class="docutils literal notranslate"><span class="pre">double</span> <span class="pre">*</span></code>.)</p></li>
</ol>
</section>
<section id="id10">
<h3>Cython<a class="headerlink" href="#id10" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>Look at the code that Cython autogenerates. Take a closer look at some of the
comments that Cython inserts. What do you see?</p></li>
<li><p>Look at the section <a class="reference external" href="https://docs.cython.org/en/latest/src/tutorial/numpy.html">Working with NumPy</a> from the Cython
documentation to learn how to incrementally optimize a pure python script that uses NumPy.</p></li>
<li><p>Modify the NumPy example such that <code class="docutils literal notranslate"><span class="pre">cos_doubles_func</span></code> handles the preallocation for
you, thus making it more like the NumPy-C-API example.</p></li>
</ol>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./advanced/interfacing_with_c"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="../mathematical_optimization/index.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Mathematical optimization: finding minima of functions</p>
      </div>
    </a>
    <a class="right-next"
       href="../../packages/index.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Packages and applications</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#introduction">Introduction</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#python-c-api">Python-C-Api</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#example">Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#numpy-support">NumPy Support</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ctypes">Ctypes</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id1">Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id2">NumPy Support</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#swig">SWIG</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id3">Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id4">NumPy Support</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#cython">Cython</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id5">Example</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id6">NumPy Support</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#summary">Summary</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#further-reading-and-references">Further Reading and References</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#exercises">Exercises</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id7">Python-C-API</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id8">Ctypes</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id9">SWIG</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#id10">Cython</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Scientific Python developers
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2025.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=dfe6caa3a7d634c4db9b"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=dfe6caa3a7d634c4db9b"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>